## å‰è¨€

### å¿…è¯»

[51å•ç‰‡æœºå…¥é—¨æ•™ç¨‹(ä¸Šç¯‡)(ä»£ç ï¼‹ä¸ªäººç†è§£) â€“ Echo (liveout.cn)](https://www.liveout.cn/51stc89c52code1/)

è¿™ç¯‡æ–‡ç« æ˜¯è®°å½•æˆ‘ç²—ç•¥å­¦ä¹ 51å•ç‰‡æœºçš„ä¸€äº›ä»£ç ï¼Œæˆ‘ä¼šåŠ äº›ä¸ªäººç†è§£ä»¥åŠæ³¨é‡Šåœ¨é‡Œé¢ã€‚

å› ä¸ºæ˜¯å›«å›µåæ£å¼å­¦ä¹ ï¼Œæ‰€ä»¥è´¨é‡ä¸æ˜¯å¾ˆå¥½ï¼ŒåæœŸæˆ‘ä¼šæ…¢æ…¢ä¼˜åŒ– ğŸ™ˆ

å¦‚æœä½ æƒ³è¦å­¦ä¹ å•ç‰‡æœºï¼Œå¯ä»¥è§‚çœ‹ä¸‹é¢çš„Bç«™æ•™ç¨‹å¹¶é…åˆæœ¬æ–‡æ¡£å­¦ä¹ 

æœ¬æ–‡ç« ä½¿ç”¨çš„51å•ç‰‡æœºæ˜¯ æ™®ä¸­STC89C52RC

### æ•™ç¨‹

**æ¨èBç«™è§†é¢‘**ï¼š ã€51å•ç‰‡æœºå…¥é—¨æ•™ç¨‹-2020ç‰ˆ ç¨‹åºå…¨ç¨‹çº¯æ‰‹æ‰“ ä»é›¶å¼€å§‹å…¥é—¨ã€‘ https://www.bilibili.com/video/BV1Mb411e7re/?share_source=copy_web&vd_source=55024add0415795a359bd7b29ca21142(åº”è¯¥éƒ½çŸ¥é“å§)ã€‚

### èµ„æº

**Bç«™æ±Ÿç§‘å¤§èµ„æº**  é“¾æ¥ï¼šhttps://pan.baidu.com/s/1dLED_1VqL66qYItLl5ic4A?pwd=1111    æå–ç ï¼š1111

**æ™®ä¸­**    é“¾æ¥ï¼šhttps://pan.baidu.com/s/1dNCHm9lLMP8pe3rZu3ktZQ?pwd=1111  æå–ç ï¼š1111             

---


## 9. LEDç‚¹é˜µå± 

### åŸç†

![88LED](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/88LED.png)

88LEDå¼•è„š
![88LEDå¼•è„š](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/88LED%E5%BC%95%E8%84%9A%E5%AF%B9%E5%BA%94.png)

![74HC595](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/74HC595.png)

`74HC595`æ˜¯ä¸²è¡Œè¾“å…¥å¹¶è¡Œè¾“å‡ºçš„ç§»ä½å¯„å­˜å™¨ï¼Œ3æ ¹çº¿è¾“å…¥ä¸²è¡Œæ•°æ®ï¼Œ8æ ¹çº¿è¾“å‡ºæ¯”å¹¶è¡Œæ•°æ®ï¼Œå¤šç‰‡çº§åï¼Œå¯è¾“å‡º16ä¸ºã€24ä¸ºã€32ä½ç­‰ï¼Œå¸¸ç”¨äºIOå£æ‰©å±•

###  9.1 LEDç‚¹é˜µæ˜¾ç¤ºå›¾å½¢

```C
#include <REGX52.H>
#include "Delay.h"
sbit RCK=P3^5;  //RCLK ä¸Šå‡æ²¿é”å­˜
sbit SCK=P3^6;  //SRCLK ä¸Šå‡æ²¿ç§»ä½
sbit SER=P3^4;  //SER

#define MATRIX_LED_PORT     P0

//Function Definition
/**
  * @brief 74HC595å†™å…¥ä¸€ä¸ªå­—èŠ‚
  * @param  è¦å†™å…¥çš„å­—èŠ‚
  * @retval æ— 
  */


void _74HC595_WriteByte(unsigned char Byte) 
{
	unsigned char i;
	for (i=0;i<8;i++)  
	{
		SER=Byte&(0x80>>i);  //1000 0000 
	  SCK=1;
	  SCK=0;
	}
	RCK=1;
	RCK=0;
}

//Function Definition
/**
  * @brief LEDç‚¹é˜µå±æ˜¾ç¤ºä¸€åˆ—æ•°æ®
  * @param  Column è¦é€‰æ‹©çš„åˆ—ï¼ŒèŒƒå›´ï¼š0~7ï¼Œ0åœ¨æœ€å·¦è¾¹
  * @param  Data é€‰æ‹©åˆ—æ˜¾ç¤ºçš„æ•°æ®ï¼Œé«˜ä½åœ¨ä¸Šï¼Œ1ä½äº®ï¼Œ0ä½ç­
  * @retval æ—           
  */

void MatrixLED_ShowColumn(unsigned char Column,Data)
{
	_74HC595_WriteByte(Data);  //Data==Byte
	MATRIX_LED_PORT=~(0x80>>Column); //0é€‰ä¸­ï¼Œ1ä¸é€‰ä¸­
  Delay(1); //å»¶è¿Ÿ
  MATRIX_LED_PORT=0xFF;  //å…¨ç­  æ¶ˆå½±
}


void main()
{
	SCK=0; //åˆšå¼€å§‹æ˜¯é«˜ç”µå¹³ï¼Œæ‰€ä»¥è¦ç½®0ï¼Œä½¿å…¶ä¸ºä½ç”µå¹³
	RCK=0;
	
	while(1)
	{
		MatrixLED_ShowColumn(0,0x3C); //1äº®0ä¸äº®
		MatrixLED_ShowColumn(1,0x42);
		MatrixLED_ShowColumn(2,0xA9);
		MatrixLED_ShowColumn(3,0x85);
		MatrixLED_ShowColumn(4,0x85);
		MatrixLED_ShowColumn(5,0xA9);
		MatrixLED_ShowColumn(6,0x42);
		MatrixLED_ShowColumn(7,0x3C);
	}
}
```

### 9.2 LEDç‚¹é˜µæ˜¾ç¤ºåŠ¨ç”»

`å¤´æ–‡ä»¶`

```C
//MatrixLED.h
#ifndef __MATRIX_LED_H_
#define __MATRIX_LED_H_
void MatrixLED_Init();
void _74HC595_WriteByte(unsigned char Byte);
void MatrixLED_ShowColumn(unsigned char Column,Data);
#endif

```

```C
//Delay.h
#ifndef __DELAY_H_
#define __DELAY_H_
void Delay(unsigned int xms);
#endif
```

`å‡½æ•°`

```C
//MatrixLED.c
#include <REGX52.H>
#include "Delay.h"

sbit RCK=P3^5;  //RCLK ä¸Šå‡æ²¿é”å­˜
sbit SCK=P3^6;  //SRCLK ä¸Šå‡æ²¿ç§»ä½
sbit SER=P3^4;  //SER

#define MATRIX_LED_PORT     P0

//Function Definition
/**
  * @brief 74HC595å†™å…¥ä¸€ä¸ªå­—èŠ‚
  * @param  è¦å†™å…¥çš„å­—èŠ‚
  * @retval æ— 
  */


void _74HC595_WriteByte(unsigned char Byte) 
{
	unsigned char i;
	for (i=0;i<8;i++)  
	{
		SER=Byte&(0x80>>i);  //1000 0000 
	  SCK=1;
	  SCK=0;
	}
	RCK=1;
	RCK=0;
}


//Function Definition
/**
  * @brief ç‚¹é˜µå±åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void MatrixLED_Init()
{
	SCK=0; //åˆšå¼€å§‹æ˜¯é«˜ç”µå¹³ï¼Œæ‰€ä»¥è¦ç½®0ï¼Œä½¿å…¶ä¸ºä½ç”µå¹³
	RCK=0;
}

//Function Definition
/**
  * @brief LEDç‚¹é˜µå±æ˜¾ç¤ºä¸€åˆ—æ•°æ®
  * @param  Column è¦é€‰æ‹©çš„åˆ—ï¼ŒèŒƒå›´ï¼š0~7ï¼Œ0åœ¨æœ€å·¦è¾¹
  * @param  Data é€‰æ‹©åˆ—æ˜¾ç¤ºçš„æ•°æ®ï¼Œé«˜ä½åœ¨ä¸Šï¼Œ1ä½äº®ï¼Œ0ä½ç­
  * @retval æ—           
  */

void MatrixLED_ShowColumn(unsigned char Column,Data)
{
	_74HC595_WriteByte(Data);  //Data==Byte
	MATRIX_LED_PORT=~(0x80>>Column); //0é€‰ä¸­ï¼Œ1ä¸é€‰ä¸­
  Delay(1); //å»¶è¿Ÿ
  MATRIX_LED_PORT=0xFF;  //å…¨ç­  æ¶ˆå½±
}

```

```C
//Delay.c
//Function Definition
/**
  * @brief å»¶è¿Ÿå‡½æ•°
  * @param  æ— 
  * @retval 1ms
  */
void Delay(unsigned int xms)		//@11.0592MHz
{
	unsigned char i, j;
	while(xms)
	{
			i = 2;
			j = 199;
			do
			{
				while (--j);
			} while (--i);	
			xms--;
	}
} 
```

`1. é€šè¿‡æµåŠ¨å®ç°åŠ¨ç”»`

```C
//main.c  é€šè¿‡æµåŠ¨å®ç°åŠ¨ç”»
#include <REGX52.H>
#include "Delay.h"
#include "MatrixLED.h"

unsigned char Animation[]={0x00,0x00,0x00,0x81,0xFF,0x81,0x00,0x00,
	0x7E,0x02,0x02,0x00,0x3C,0x42,0x42,0x3C,
	0x00,0x30,0x0C,0x02,0x0C,0x30,0x00,0x3E,
	0x2A,0x2A,0x00,0x00,0x60,0x18,0x06,0x18,0x60,
	0x00
};

void main()
{
	unsigned char i,Offset=1,Count=0;  //Offsetåç§»é‡,å³æ•°ç»„ç¬¬å‡ åˆ— Countæ§åˆ¶ç§»åŠ¨é€Ÿåº¦
	MatrixLED_Init();
	while(1)
	{
		for (i=0; i<8; i++)
		{
			MatrixLED_ShowColumn(i,Animation[i+Offset]);
		}
		Count++;
		if (Count>12)
		{
			Count=0;
			Offset++;
			if(Offset>24) //é˜²æ­¢æ•°ç»„æº¢å‡º
			{
				Offset=0;
			}	
		}
	}
}
```

`2. é€šè¿‡æ¯æ¬¡åˆ·æ–°(å³æ¯å¸§)å®ç°åŠ¨ç”»`

```C
//main.c  é€šè¿‡æ¯æ¬¡åˆ·æ–°(å³æ¯å¸§)å®ç°åŠ¨ç”»
#include <REGX52.H>
#include "Delay.h"
#include "MatrixLED.h"

unsigned char code Animation[]={
	0x00,0x0C,0x1C,0x21,0xDE,0xE0,0x3F,0x10,
	0x00,0x06,0x16,0x21,0xDE,0xE0,0x3F,0x10,
	0x00,0x03,0x13,0x21,0xDE,0xE0,0x3F,0x10,
	0x0C,0x0C,0x10,0x21,0xDE,0xE0,0x3F,0x10,
	0x00,0x0C,0x1C,0x21,0xDE,0xE0,0x3F,0x10,
}; //åŠ codeè¿™äº›æ•°æ®ä¼šæ”¾åœ¨flashé‡Œé¢ï¼Œä¸ç„¶åœ¨RAMé‡Œã€‚flashå†…å­˜è¾ƒå¤§
//ä½†æ˜¯åé¢æ•°ç»„æ— æ³•æ›´æ”¹

void main()
{
	unsigned char i,Offset=0,Count=0;  //Offsetåç§»é‡,å³æ•°ç»„ç¬¬å‡ åˆ— Countæ§åˆ¶å˜æ¢é€Ÿåº¦
	MatrixLED_Init();
	while(1)
	{
		for (i=0; i<8; i++)
		{
			MatrixLED_ShowColumn(i,Animation[i+Offset]);
		}
		Count++;
		if (Count>15)
		{
			Count=0;
			Offset+=8;
			if(Offset>32) //é˜²æ­¢æ•°ç»„æº¢å‡º
			{
				Offset=0;
			}		
		}
	}
}
```

---

## 10. DS1302æ—¶é’Ÿ

DS1302ï¼šä½åŠŸè€—å®æ—¶æ—¶é’ŸèŠ¯ç‰‡ï¼Œå¯ä»¥å¯¹å¹´ã€æœˆã€æ—¥ã€å‘¨ã€æ—¶ã€åˆ†ã€ç§’è¿›è¡Œè®¡æ—¶ï¼Œä¸”å…·æœ‰é—°å¹´è¡¥å¿ç­‰å¤šç§åŠŸèƒ½

RTCï¼šå®æ—¶æ—¶é’Ÿï¼Œæ˜¯ä¸€ç§é›†æˆç”µè·¯ï¼Œé€šå¸¸ç§°ä¸ºæ—¶é’ŸèŠ¯ç‰‡(51å•ç‰‡æœºä¸å¸¦)

BCDç ï¼šç”¨4ä½äºŒè¿›åˆ¶æ•°æ¥è¡¨ç¤º1ä½åè¿›åˆ¶æ•°  å¦‚ï¼š0001 0011 è¡¨ç¤º13ï¼Œè€Œ 0001 1010 åˆ™ä¸åˆæ³•

### åŸç† 

é˜…è¯»å‚å®¶æä¾›çš„DS1302ä¸­æ–‡æ‰‹å†Œ

<img src="https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/DS1302.png" alt="DS1302æ—¶é’Ÿ" style="zoom:50%;" />

 

### 10.1 DS1302æ—¶é’Ÿ

`å¤´æ–‡ä»¶`

```C
//DS1302.h
#ifndef __DS1302_H__
#define __DS1302_H__

//å¤–éƒ¨å¯è°ƒç”¨æ—¶é—´æ•°ç»„ï¼Œç´¢å¼•0~6åˆ†åˆ«ä¸ºå¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ã€æ˜ŸæœŸ
extern unsigned char DS1302_Time[];

void DS1302_Init(void);
void DS1302_WriteByte(unsigned char Command,Data);
unsigned char DS1302_ReadByte(unsigned char Command);
void DS1302_SetTime(void);
void DS1302_ReadTime(void);

#endif

```

`å‡½æ•°`

```C
//DS1302.c
#include <REGX52.H>

//å¼•è„šå®šä¹‰
sbit DS1302_SCLK=P3^6;
sbit DS1302_IO=P3^4;
sbit DS1302_CE=P3^5;

//å¯„å­˜å™¨å†™å…¥åœ°å€/æŒ‡ä»¤å®šä¹‰
#define DS1302_SECOND		0x80
#define DS1302_MINUTE		0x82
#define DS1302_HOUR			0x84
#define DS1302_DATE			0x86
#define DS1302_MONTH		0x88
#define DS1302_DAY			0x8A
#define DS1302_YEAR			0x8C
#define DS1302_WP			0x8E

//æ—¶é—´æ•°ç»„ï¼Œç´¢å¼•0~6åˆ†åˆ«ä¸ºå¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ã€æ˜ŸæœŸ
unsigned char DS1302_Time[]={19,11,16,12,59,55,6};

/**
  * @brief  DS1302åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void DS1302_Init(void)
{
	DS1302_CE=0;
	DS1302_SCLK=0;
}

/**
  * @brief  DS1302å†™ä¸€ä¸ªå­—èŠ‚
  * @param  Command å‘½ä»¤å­—/åœ°å€
  * @param  Data è¦å†™å…¥çš„æ•°æ®
  * @retval æ— 
  */
void DS1302_WriteByte(unsigned char Command,Data)
{
	unsigned char i;
	DS1302_CE=1;
	for(i=0;i<8;i++)
	{
		DS1302_IO=Command&(0x01<<i);
		DS1302_SCLK=1;
		DS1302_SCLK=0;
	}
	for(i=0;i<8;i++)
	{
		DS1302_IO=Data&(0x01<<i);
		DS1302_SCLK=1;
		DS1302_SCLK=0;
	}
	DS1302_CE=0;
}

/**
  * @brief  DS1302è¯»ä¸€ä¸ªå­—èŠ‚
  * @param  Command å‘½ä»¤å­—/åœ°å€
  * @retval è¯»å‡ºçš„æ•°æ®
  */
unsigned char DS1302_ReadByte(unsigned char Command)
{
	unsigned char i,Data=0x00;
	Command|=0x01;	//å°†æŒ‡ä»¤è½¬æ¢ä¸ºè¯»æŒ‡ä»¤
	DS1302_CE=1;
	for(i=0;i<8;i++)
	{
		DS1302_IO=Command&(0x01<<i);
		DS1302_SCLK=0;
		DS1302_SCLK=1;
	}
	for(i=0;i<8;i++)
	{
		DS1302_SCLK=1;
		DS1302_SCLK=0;
		if(DS1302_IO){Data|=(0x01<<i);}
	}
	DS1302_CE=0;
	DS1302_IO=0;	//è¯»å–åå°†IOè®¾ç½®ä¸º0ï¼Œå¦åˆ™è¯»å‡ºçš„æ•°æ®ä¼šå‡ºé”™
	return Data;
}

/**
  * @brief  DS1302è®¾ç½®æ—¶é—´ï¼Œè°ƒç”¨ä¹‹åï¼ŒDS1302_Timeæ•°ç»„çš„æ•°å­—ä¼šè¢«è®¾ç½®åˆ°DS1302ä¸­
  * @param  æ— 
  * @retval æ— 
  */
void DS1302_SetTime(void)
{
	DS1302_WriteByte(DS1302_WP,0x00);
	DS1302_WriteByte(DS1302_YEAR,DS1302_Time[0]/10*16+DS1302_Time[0]%10);//åè¿›åˆ¶è½¬BCDç åå†™å…¥
	DS1302_WriteByte(DS1302_MONTH,DS1302_Time[1]/10*16+DS1302_Time[1]%10);
	DS1302_WriteByte(DS1302_DATE,DS1302_Time[2]/10*16+DS1302_Time[2]%10);
	DS1302_WriteByte(DS1302_HOUR,DS1302_Time[3]/10*16+DS1302_Time[3]%10);
	DS1302_WriteByte(DS1302_MINUTE,DS1302_Time[4]/10*16+DS1302_Time[4]%10);
	DS1302_WriteByte(DS1302_SECOND,DS1302_Time[5]/10*16+DS1302_Time[5]%10);
	DS1302_WriteByte(DS1302_DAY,DS1302_Time[6]/10*16+DS1302_Time[6]%10);
	DS1302_WriteByte(DS1302_WP,0x80);
}

/**
  * @brief  DS1302è¯»å–æ—¶é—´ï¼Œè°ƒç”¨ä¹‹åï¼ŒDS1302ä¸­çš„æ•°æ®ä¼šè¢«è¯»å–åˆ°DS1302_Timeæ•°ç»„ä¸­
  * @param  æ— 
  * @retval æ— 
  */
void DS1302_ReadTime(void)
{
	unsigned char Temp;
	Temp=DS1302_ReadByte(DS1302_YEAR);
	DS1302_Time[0]=Temp/16*10+Temp%16;//BCDç è½¬åè¿›åˆ¶åè¯»å–
	Temp=DS1302_ReadByte(DS1302_MONTH);
	DS1302_Time[1]=Temp/16*10+Temp%16;
	Temp=DS1302_ReadByte(DS1302_DATE);
	DS1302_Time[2]=Temp/16*10+Temp%16;
	Temp=DS1302_ReadByte(DS1302_HOUR);
	DS1302_Time[3]=Temp/16*10+Temp%16;
	Temp=DS1302_ReadByte(DS1302_MINUTE);
	DS1302_Time[4]=Temp/16*10+Temp%16;
	Temp=DS1302_ReadByte(DS1302_SECOND);
	DS1302_Time[5]=Temp/16*10+Temp%16;
	Temp=DS1302_ReadByte(DS1302_DAY);
	DS1302_Time[6]=Temp/16*10+Temp%16;
}
```

```C
//main.c
#include <REGX52.H>
#include "LCD1602.h"
#include "DS1302.h"

void main()
{
	LCD_Init();
	DS1302_Init();
	LCD_ShowString(1,1,"  -  -  ");//é™æ€å­—ç¬¦åˆå§‹åŒ–æ˜¾ç¤º
	LCD_ShowString(2,1,"  :  :  ");
	
	DS1302_SetTime();//è®¾ç½®æ—¶é—´
	
	while(1)
	{
		DS1302_ReadTime();//è¯»å–æ—¶é—´
		LCD_ShowNum(1,1,DS1302_Time[0],2);//æ˜¾ç¤ºå¹´
		LCD_ShowNum(1,4,DS1302_Time[1],2);//æ˜¾ç¤ºæœˆ
		LCD_ShowNum(1,7,DS1302_Time[2],2);//æ˜¾ç¤ºæ—¥
		LCD_ShowNum(2,1,DS1302_Time[3],2);//æ˜¾ç¤ºæ—¶
		LCD_ShowNum(2,4,DS1302_Time[4],2);//æ˜¾ç¤ºåˆ†
		LCD_ShowNum(2,7,DS1302_Time[5],2);//æ˜¾ç¤ºç§’
	}
}
```

### 10.2 DS1302å¯è°ƒæ—¶é’Ÿ

```C
#include <REGX52.H>
#include "LCD1602.h"
#include "DS1302.h"
#include "Key.h"
#include "Timer0.h"

unsigned char KeyNum,MODE,TimeSetSelect,TimeSetFlashFlag;

void TimeShow(void)//æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½
{
	DS1302_ReadTime();//è¯»å–æ—¶é—´
	LCD_ShowNum(1,1,DS1302_Time[0],2);//æ˜¾ç¤ºå¹´
	LCD_ShowNum(1,4,DS1302_Time[1],2);//æ˜¾ç¤ºæœˆ
	LCD_ShowNum(1,7,DS1302_Time[2],2);//æ˜¾ç¤ºæ—¥
	LCD_ShowNum(2,1,DS1302_Time[3],2);//æ˜¾ç¤ºæ—¶
	LCD_ShowNum(2,4,DS1302_Time[4],2);//æ˜¾ç¤ºåˆ†
	LCD_ShowNum(2,7,DS1302_Time[5],2);//æ˜¾ç¤ºç§’
}

void TimeSet(void)//æ—¶é—´è®¾ç½®åŠŸèƒ½
{
	if(KeyNum==2)//æŒ‰é”®2æŒ‰ä¸‹
	{
		TimeSetSelect++;//è®¾ç½®é€‰æ‹©ä½åŠ 1
		TimeSetSelect%=6;//è¶Šç•Œæ¸…é›¶
	}
	if(KeyNum==3)//æŒ‰é”®3æŒ‰ä¸‹
	{
		DS1302_Time[TimeSetSelect]++;//æ—¶é—´è®¾ç½®ä½æ•°å€¼åŠ 1
		if(DS1302_Time[0]>99){DS1302_Time[0]=0;}//å¹´è¶Šç•Œåˆ¤æ–­
		if(DS1302_Time[1]>12){DS1302_Time[1]=1;}//æœˆè¶Šç•Œåˆ¤æ–­
		if( DS1302_Time[1]==1 || DS1302_Time[1]==3 || DS1302_Time[1]==5 || DS1302_Time[1]==7 || 
			DS1302_Time[1]==8 || DS1302_Time[1]==10 || DS1302_Time[1]==12)//æ—¥è¶Šç•Œåˆ¤æ–­
		{
			if(DS1302_Time[2]>31){DS1302_Time[2]=1;}//å¤§æœˆ
		}
		else if(DS1302_Time[1]==4 || DS1302_Time[1]==6 || DS1302_Time[1]==9 || DS1302_Time[1]==11)
		{
			if(DS1302_Time[2]>30){DS1302_Time[2]=1;}//å°æœˆ
		}
		else if(DS1302_Time[1]==2)
		{
			if(DS1302_Time[0]%4==0)
			{
				if(DS1302_Time[2]>29){DS1302_Time[2]=1;}//é—°å¹´2æœˆ
			}
			else
			{
				if(DS1302_Time[2]>28){DS1302_Time[2]=1;}//å¹³å¹´2æœˆ
			}
		}
		if(DS1302_Time[3]>23){DS1302_Time[3]=0;}//æ—¶è¶Šç•Œåˆ¤æ–­
		if(DS1302_Time[4]>59){DS1302_Time[4]=0;}//åˆ†è¶Šç•Œåˆ¤æ–­
		if(DS1302_Time[5]>59){DS1302_Time[5]=0;}//ç§’è¶Šç•Œåˆ¤æ–­
	}
	if(KeyNum==4)//æŒ‰é”®3æŒ‰ä¸‹
	{
		DS1302_Time[TimeSetSelect]--;//æ—¶é—´è®¾ç½®ä½æ•°å€¼å‡1
		if(DS1302_Time[0]<0){DS1302_Time[0]=99;}//å¹´è¶Šç•Œåˆ¤æ–­
		if(DS1302_Time[1]<1){DS1302_Time[1]=12;}//æœˆè¶Šç•Œåˆ¤æ–­
		if( DS1302_Time[1]==1 || DS1302_Time[1]==3 || DS1302_Time[1]==5 || DS1302_Time[1]==7 || 
			DS1302_Time[1]==8 || DS1302_Time[1]==10 || DS1302_Time[1]==12)//æ—¥è¶Šç•Œåˆ¤æ–­
		{
			if(DS1302_Time[2]<1){DS1302_Time[2]=31;}//å¤§æœˆ
			if(DS1302_Time[2]>31){DS1302_Time[2]=1;}
		}
		else if(DS1302_Time[1]==4 || DS1302_Time[1]==6 || DS1302_Time[1]==9 || DS1302_Time[1]==11)
		{
			if(DS1302_Time[2]<1){DS1302_Time[2]=30;}//å°æœˆ
			if(DS1302_Time[2]>30){DS1302_Time[2]=1;}
		}
		else if(DS1302_Time[1]==2)
		{
			if(DS1302_Time[0]%4==0)
			{
				if(DS1302_Time[2]<1){DS1302_Time[2]=29;}//é—°å¹´2æœˆ
				if(DS1302_Time[2]>29){DS1302_Time[2]=1;}
			}
			else
			{
				if(DS1302_Time[2]<1){DS1302_Time[2]=28;}//å¹³å¹´2æœˆ
				if(DS1302_Time[2]>28){DS1302_Time[2]=1;}
			}
		}
		if(DS1302_Time[3]<0){DS1302_Time[3]=23;}//æ—¶è¶Šç•Œåˆ¤æ–­
		if(DS1302_Time[4]<0){DS1302_Time[4]=59;}//åˆ†è¶Šç•Œåˆ¤æ–­
		if(DS1302_Time[5]<0){DS1302_Time[5]=59;}//ç§’è¶Šç•Œåˆ¤æ–­
	}
	//æ›´æ–°æ˜¾ç¤ºï¼Œæ ¹æ®TimeSetSelectå’ŒTimeSetFlashFlagåˆ¤æ–­å¯å®Œæˆé—ªçƒåŠŸèƒ½
	if(TimeSetSelect==0 && TimeSetFlashFlag==1){LCD_ShowString(1,1,"  ");}
	else {LCD_ShowNum(1,1,DS1302_Time[0],2);}
	if(TimeSetSelect==1 && TimeSetFlashFlag==1){LCD_ShowString(1,4,"  ");}
	else {LCD_ShowNum(1,4,DS1302_Time[1],2);}
	if(TimeSetSelect==2 && TimeSetFlashFlag==1){LCD_ShowString(1,7,"  ");}
	else {LCD_ShowNum(1,7,DS1302_Time[2],2);}
	if(TimeSetSelect==3 && TimeSetFlashFlag==1){LCD_ShowString(2,1,"  ");}
	else {LCD_ShowNum(2,1,DS1302_Time[3],2);}
	if(TimeSetSelect==4 && TimeSetFlashFlag==1){LCD_ShowString(2,4,"  ");}
	else {LCD_ShowNum(2,4,DS1302_Time[4],2);}
	if(TimeSetSelect==5 && TimeSetFlashFlag==1){LCD_ShowString(2,7,"  ");}
	else {LCD_ShowNum(2,7,DS1302_Time[5],2);}
}

void main()
{
	LCD_Init();
	DS1302_Init();
	Timer0Init();
	LCD_ShowString(1,1,"  -  -  ");//é™æ€å­—ç¬¦åˆå§‹åŒ–æ˜¾ç¤º
	LCD_ShowString(2,1,"  :  :  ");
	
	DS1302_SetTime();//è®¾ç½®æ—¶é—´
	
	while(1)
	{
		KeyNum=Key();//è¯»å–é”®ç 
		if(KeyNum==1)//æŒ‰é”®1æŒ‰ä¸‹
		{
			if(MODE==0){MODE=1;TimeSetSelect=0;}//åŠŸèƒ½åˆ‡æ¢
			else if(MODE==1){MODE=0;DS1302_SetTime();}
		}
		switch(MODE)//æ ¹æ®ä¸åŒçš„åŠŸèƒ½æ‰§è¡Œä¸åŒçš„å‡½æ•°
		{
			case 0:TimeShow();break;
			case 1:TimeSet();break;
		}
	}
}

void Timer0_Routine() interrupt 1
{
	static unsigned int T0Count;
	TL0 = 0x18;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0xFC;		//è®¾ç½®å®šæ—¶åˆå€¼
	T0Count++;
	if(T0Count>=500)//æ¯500msè¿›å…¥ä¸€æ¬¡
	{
		T0Count=0;
		TimeSetFlashFlag=!TimeSetFlashFlag;//é—ªçƒæ ‡å¿—ä½å–å
	}
}

```

---

## 11. èœ‚é¸£å™¨

### åŸç†

![èœ‚é¸£å™¨](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/%E8%9C%82%E9%B8%A3%E5%99%A8.png) 

![ Cè°ƒéŸ³ç¬¦ä¸é¢‘ç‡å¯¹ç…§è¡¨](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/C%E8%B0%83%E9%9F%B3%E7%AC%A6%E4%B8%8E%E9%A2%91%E7%8E%87%E5%AF%B9%E7%85%A7%E8%A1%A8.bmp) 

### 11.1 èœ‚é¸£å™¨æ’­æ”¾æç¤ºéŸ³

`å¤´æ–‡ä»¶`

```C
//Buzzer.h
#ifndef __BUZZER_H__
#define __BUZZER_H__

void Buzzer_Time(unsigned int ms);

#endif
```

`å‡½æ•°`

```C
//Buzzer.c
#include <REGX52.H>
#include <INTRINS.H>

//èœ‚é¸£å™¨ç«¯å£ï¼š
sbit Buzzer=P2^5;

/**
  * @brief  èœ‚é¸£å™¨ç§æœ‰å»¶æ—¶å‡½æ•°ï¼Œå»¶æ—¶500us
  * @param  æ— 
  * @retval æ— 
  */
void Buzzer_Delay500us()		//@12.000MHz
{
	unsigned char i;

	_nop_();
	i = 247;
	while (--i);
}

/**
  * @brief  èœ‚é¸£å™¨å‘å£°
  * @param  ms å‘å£°çš„æ—¶é•¿ï¼ŒèŒƒå›´ï¼š0~32767
  * @retval æ— 
  */
void Buzzer_Time(unsigned int ms)
{
	unsigned int i;
	for(i=0;i<ms*2;i++)
	{
		Buzzer=!Buzzer;
		Buzzer_Delay500us();
	}
}
```

```C
//mian.c
#include <REGX52.H>
#include "Delay.h"
#include "Key.h"
#include "Nixie.h"
#include "Buzzer.h"

sbit Buzzer=P2^5;

unsigned char KeyNum;
unsigned int i;

void main()
{
	 Nixie(1,0);
	while(1)
	{
		KeyNum=Key();
		if(KeyNum)
		{
			for(i=0; i<100; i++)
			{
				Buzzer=!Buzzer;
				Delay(1);
			}
			Buzzer_Time(100);
			Nixie(1,KeyNum);
		}
	}
}
```

### 11.2 èœ‚é¸£å™¨æ’­æ”¾éŸ³ä¹

```C
#include <REGX52.H>
#include "Delay.h"
#include "Timer0.h"

//èœ‚é¸£å™¨ç«¯å£å®šä¹‰
sbit Buzzer=P2 ^5;

//æ’­æ”¾é€Ÿåº¦ï¼Œå€¼ä¸ºå››åˆ†éŸ³ç¬¦çš„æ—¶é•¿(ms)
#define SPEED	500

//éŸ³ç¬¦ä¸ç´¢å¼•å¯¹åº”è¡¨ï¼ŒPï¼šä¼‘æ­¢ç¬¦ï¼ŒLï¼šä½éŸ³ï¼ŒMï¼šä¸­éŸ³ï¼ŒHï¼šé«˜éŸ³ï¼Œä¸‹åˆ’çº¿ï¼šå‡åŠéŸ³ç¬¦å·#
#define P	0
#define L1	1
#define L1_	2
#define L2	3
#define L2_	4
#define L3	5
#define L4	6
#define L4_	7
#define L5	8
#define L5_	9
#define L6	10
#define L6_	11
#define L7	12
#define M1	13
#define M1_	14
#define M2	15
#define M2_	16
#define M3	17
#define M4	18
#define M4_	19
#define M5	20
#define M5_	21
#define M6	22
#define M6_	23
#define M7	24
#define H1	25
#define H1_	26
#define H2	27
#define H2_	28
#define H3	29
#define H4	30
#define H4_	31
#define H5	32
#define H5_	33
#define H6	34
#define H6_	35
#define H7	36

//ç´¢å¼•ä¸é¢‘ç‡å¯¹ç…§è¡¨
unsigned int FreqTable[]={
	0,
	63628,63731,63835,63928,64021,64103,64185,64260,64331,64400,64463,64528,
	64580,64633,64684,64732,64777,64820,64860,64898,64934,64968,65000,65030,
	65058,65085,65110,65134,65157,65178,65198,65217,65235,65252,65268,65283,
};

//ä¹è°±
unsigned char code Music[]={
	//éŸ³ç¬¦,æ—¶å€¼,
	
	//1
	P,	4,
	P,	4,
	P,	4,
	M6,	2,
	M7,	2,
	
	H1,	4+2,
	M7,	2,
	H1,	4,
	H3,	4,
	
	M7,	4+4+4,
	M3,	2,
	M3,	2,
	
	//2
	M6,	4+2,
	M5,	2,
	M6, 4,
	H1,	4,
	
	M5,	4+4+4,
	M3,	4,
	
	M4,	4+2,
	M3,	2,
	M4,	4,
	H1,	4,
	
	//3
	M3,	4+4,
	P,	2,
	H1,	2,
	H1,	2,
	H1,	2,
	
	M7,	4+2,
	M4_,2,
	M4_,4,
	M7,	4,
	
	M7,	8,
	P,	4,
	M6,	2,
	M7,	2,
	
	//4
	H1,	4+2,
	M7,	2,
	H1,	4,
	H3,	4,
	
	M7,	4+4+4,
	M3,	2,
	M3,	2,
	
	M6,	4+2,
	M5,	2,
	M6, 4,
	H1,	4,
	
	//5
	M5,	4+4+4,
	M2,	2,
	M3,	2,
	
	M4,	4,
	H1,	2,
	M7,	2+2,
	H1,	2+4,
	
	H2,	2,
	H2,	2,
	H3,	2,
	H1,	2+4+4,
	
	//6
	H1,	2,
	M7,	2,
	M6,	2,
	M6,	2,
	M7,	4,
	M5_,4,
	
	
	M6,	4+4+4,
	H1,	2,
	H2,	2,
	
	H3,	4+2,
	H2,	2,
	H3,	4,
	H5,	4,
	
	//7
	H2,	4+4+4,
	M5,	2,
	M5,	2,
	
	H1,	4+2,
	M7,	2,
	H1,	4,
	H3,	4,
	
	H3,	4+4+4+4,
	
	//8
	M6,	2,
	M7,	2,
	H1,	4,
	M7,	4,
	H2,	2,
	H2,	2,
	
	H1,	4+2,
	M5,	2+4+4,
	
	H4,	4,
	H3,	4,
	H3,	4,
	H1,	4,
	
	//9
	H3,	4+4+4,
	H3,	4,
	
	H6,	4+4,
	H5,	4,
	H5,	4,
	
	H3,	2,
	H2,	2,
	H1,	4+4,
	P,	2,
	H1,	2,
	
	//10
	H2,	4,
	H1,	2,
	H2,	2,
	H2,	4,
	H5,	4,
	
	H3,	4+4+4,
	H3,	4,
	
	H6,	4+4,
	H5,	4+4,
	
	//11
	H3,	2,
	H2,	2,
	H1,	4+4,
	P,	2,
	H1,	2,
	
	H2,	4,
	H1,	2,
	H2,	2+4,
	M7,	4,
	
	M6,	4+4+4,
	P,	4,
	
	0xFF	//ç»ˆæ­¢æ ‡å¿—
};

unsigned char FreqSelect,MusicSelect;

void main()
{
	Timer0Init(); //å®šæ—¶å™¨0åˆå§‹åŒ–
	while(1)
	{
		if(Music[MusicSelect]!=0xFF)	//å¦‚æœä¸æ˜¯åœæ­¢æ ‡å¿—ä½
		{
			FreqSelect=Music[MusicSelect];	//é€‰æ‹©éŸ³ç¬¦å¯¹åº”çš„é¢‘ç‡
			MusicSelect++;
			Delay(SPEED/4*Music[MusicSelect]);	//é€‰æ‹©éŸ³ç¬¦å¯¹åº”çš„æ—¶å€¼
			MusicSelect++;
			TR0=0;
			Delay(5);	//éŸ³ç¬¦é—´çŸ­æš‚åœé¡¿
			TR0=1;
		}
		else	//å¦‚æœæ˜¯åœæ­¢æ ‡å¿—ä½
		{
			TR0=0;
			while(1);
		}
	}
}

void Timer0_Routine() interrupt 1
{
	if(FreqTable[FreqSelect])	//å¦‚æœä¸æ˜¯ä¼‘æ­¢ç¬¦
	{
		/*å–å¯¹åº”é¢‘ç‡å€¼çš„é‡è£…è½½å€¼åˆ°å®šæ—¶å™¨*/
		TL0 = FreqTable[FreqSelect]%256;		//è®¾ç½®å®šæ—¶åˆå€¼
		TH0 = FreqTable[FreqSelect]/256;		//è®¾ç½®å®šæ—¶åˆå€¼
		Buzzer=!Buzzer;	//ç¿»è½¬èœ‚é¸£å™¨IOå£
	}
}
```

---

## 12. AT24C02(å­˜å‚¨å™¨)

### åŸç†

![EEPROM](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/EEPROM.png)

###  12.1 AT24C02æ•°æ®å­˜å‚¨

`å¤´æ–‡ä»¶`

```C
//12C.h
#ifndef __I2C_H_
#define __I2C_H_

void I2C_Start(void);
void I2C_Stop(void);
void I2C_SendByte(unsigned char Byte);
unsigned char I2C_ReceiveByte(void);
void I2C_SendAck(unsigned char AckBit);
unsigned char I2C_ReceiveAck(void);

#endif
```

```C
//AT24C02.h
#ifndef __AT24C02_H_
#define __AT24C02_H_

void AT24C02_WriteByte(unsigned char WordAddress,Data);
unsigned char AT24C02_ReadByte(unsigned char WordAddress);

#endif
```

`å‡½æ•°`

```C
//I2C.c
#include <REGX52.H>

sbit I2C_SCL=P2^1;
sbit I2C_SDA=P2^0;

//Function Definition
/**
  * @brief I2Cå¼€å§‹
  * @param  æ— 
  * @retval æ— 
  */
void I2C_Start(void)
{
	I2C_SDA=1; //é«˜
	I2C_SCL=1;
 	I2C_SDA=0; //ä½
	I2C_SCL=0;
}

//Function Definition
/**
  * @brief I2Cåœæ­¢
  * @param  æ— 
  * @retval æ— 
  */
void I2C_Stop(void)
{
	I2C_SDA=0; //ä½
	I2C_SCL=1; //é«˜
	I2C_SDA=1; //é«˜
}

//Function Definition
/**
  * @brief I2Cå‘é€ä¸€ä¸ªå­—èŠ‚
  * @param  Byte è¦å‘é€çš„å­—èŠ‚
  * @retval æ— 
  */
void I2C_SendByte(unsigned char Byte)
{
	unsigned char i;
	for (i=0;i<8;i++)
	{
		I2C_SDA=Byte&(0x80>>i);
		I2C_SCL=1;
		I2C_SCL=0;
	}
	
}

//Function Definition
/**
  * @brief I2Cæ¥æ”¶ä¸€ä¸ªå­—èŠ‚
  * @param  æ— 
  * @retval æ¥æ”¶åˆ°çš„ä¸€ä¸ªå­—èŠ‚æ•°æ® 
  */
unsigned char I2C_ReceiveByte(void)
{
	unsigned char Byte,i;
	
	I2C_SDA=1;
	
	for (i=0;i<8;i++)
	{
		I2C_SCL=1;
		if(I2C_SDA) {Byte|=(0x80>>i);}
		I2C_SCL=0;
	}
	return Byte;
}

//Function Definition
/**
  * @brief  I2Cå‘é€åº”ç­”ä½
  * @param  AckBit åº”ç­”ä½ï¼Œ0ä¸ºåº”ç­”ï¼Œ1ä¸ºéåº”ç­”
  * @retval æ— 
  */
void I2C_SendAck(unsigned char AckBit)
{
	I2C_SDA=AckBit;
	I2C_SCL=1;
	I2C_SCL=0;
}

//Function Definition
/**
  * @brief  I2Cæ¥æ”¶åº”ç­”ä½
  * @param  æ— 
  * @retval æ¥æ”¶åˆ°çš„åº”ç­”ä½ï¼Œ  0ä¸ºåº”ç­”ï¼Œ1ä¸ºéåº”ç­”
  */
unsigned char I2C_ReceiveAck(void)
{
	unsigned char AckBit;
	I2C_SDA=1;
	I2C_SCL=1;
	AckBit=I2C_SDA;
	I2C_SCL=0;
	return AckBit;
}
```

```C
//AT24C02.c
#include <REGX52.H>
#include "I2C.h"

#define AT24C02_ADDRESS  0xA0

//Function Definition
/**
  * @brief AT24C02å†™å…¥ä¸€ä¸ªå­—èŠ‚
  * @param  WordAddress  è¦å†™å…¥å­—èŠ‚çš„åœ°å€   Data  è¦å†™å…¥çš„æ•°æ®
  * @retval æ— 
  */
void AT24C02_WriteByte(unsigned char WordAddress,Data)
{
	I2C_Start();
	I2C_SendByte(AT24C02_ADDRESS);
	I2C_ReceiveAck();
	I2C_SendByte(WordAddress);
	I2C_ReceiveAck();
	I2C_SendByte(Data);
	I2C_ReceiveAck();
	I2C_Stop();
}

//Function Definition
/**
  * @brief  AT24C02è¯»å–ä¸€ä¸ªå­—èŠ‚
  * @param   WordAddress  è¦è¯»å‡ºå­—èŠ‚çš„åœ°å€  
  * @retval  Data  è¦è¯»å‡ºçš„æ•°æ®
  */
unsigned char AT24C02_ReadByte(unsigned char WordAddress)
{
	unsigned char Data;
	I2C_Start();
	I2C_SendByte(AT24C02_ADDRESS);
	I2C_ReceiveAck();
	I2C_SendByte(WordAddress);
	I2C_ReceiveAck();
	I2C_Start();
	I2C_SendByte(AT24C02_ADDRESS|0x01);
	I2C_ReceiveAck();
	Data=I2C_ReceiveByte();
	I2C_SendAck(1);
	I2C_Stop();
	return Data;
}
```

```C
//main.c
#include <REGX52.H>
#include "LCD1602.h"
#include "Key.h"
#include "AT24C02.h"
#include "Delay.h"

unsigned char KeyNum;
unsigned int Num;

void main()
{
	LCD_Init();
	LCD_ShowNum(1,1,Num,5);
	while(1)
	{
		KeyNum=Key();
		if(KeyNum==1)
		{
			Num++;
			LCD_ShowNum(1,1,Num,5);
		}
		
		if(KeyNum==2)
		{
			Num--;
			LCD_ShowNum(1,1,Num,5);
		}
		
		if(KeyNum==3)
		{
			AT24C02_WriteByte(0,Num%256); //ä½8ä½
			Delay(5);
			AT24C02_WriteByte(1,Num/256); //é«˜8ä½
			Delay(5);
			LCD_ShowString(2,1,"Write Ok");
			Delay(1000);
			LCD_ShowString(2,1,"         ");
		}
		
		if(KeyNum==4)
		{
			Num=AT24C02_ReadByte(0); //oåœ°å€
			Num|=AT24C02_ReadByte(1)<<8; //1åœ°å€
			LCD_ShowNum(1,1,Num,5);
			LCD_ShowString(2,1,"Read OK");
			Delay(1000);
			LCD_ShowString(2,1,"         ");
		}
	}
}
```

### 12.2 ç§’è¡¨(å®šæ—¶å™¨æ‰«ææŒ‰é”®æ•°ç ç®¡)

`å¤´æ–‡ä»¶`

```C
//Nixie.h
#ifndef __NIXIE_H__
#define __NIXIE_H__

void Nixie_SetBuf(unsigned char Location,Number);
void Nixie_Scan(unsigned char Location,Number);
void Nixie_Loop(void);

#endif
```

```C
//Key.h
#ifndef __KEY_H__
#define __KEY_H__

unsigned char Key(void);
void Key_Loop(void);

#endif
```

`å‡½æ•°`

```C
//Nixie.c
#include <REGX52.H>
#include "Delay.h"

//æ•°ç ç®¡æ˜¾ç¤ºç¼“å­˜åŒº
unsigned char Nixie_Buf[9]={0,10,10,10,10,10,10,10,10};

//æ•°ç ç®¡æ®µç è¡¨
unsigned char NixieTable[]={0x3F,0x06,0x5B,0x4F,0x66,0x6D,0x7D,0x07,0x7F,0x6F,0x00,0x40};

/**
  * @brief  è®¾ç½®æ˜¾ç¤ºç¼“å­˜åŒº
  * @param  Location è¦è®¾ç½®çš„ä½ç½®ï¼ŒèŒƒå›´ï¼š1~8
  * @param  Number è¦è®¾ç½®çš„æ•°å­—ï¼ŒèŒƒå›´ï¼šæ®µç è¡¨ç´¢å¼•èŒƒå›´
  * @retval æ— 
  */
void Nixie_SetBuf(unsigned char Location,Number)
{
	Nixie_Buf[Location]=Number;
}

/**
  * @brief  æ•°ç ç®¡æ‰«ææ˜¾ç¤º
  * @param  Location è¦æ˜¾ç¤ºçš„ä½ç½®ï¼ŒèŒƒå›´ï¼š1~8
  * @param  Number è¦æ˜¾ç¤ºçš„æ•°å­—ï¼ŒèŒƒå›´ï¼šæ®µç è¡¨ç´¢å¼•èŒƒå›´
  * @retval æ— 
  */
void Nixie_Scan(unsigned char Location,Number)
{
	P0=0x00;				//æ®µç æ¸…0ï¼Œæ¶ˆå½±
	switch(Location)		//ä½ç è¾“å‡º
	{
		case 1:P2_4=1;P2_3=1;P2_2=1;break;
		case 2:P2_4=1;P2_3=1;P2_2=0;break;
		case 3:P2_4=1;P2_3=0;P2_2=1;break;
		case 4:P2_4=1;P2_3=0;P2_2=0;break;
		case 5:P2_4=0;P2_3=1;P2_2=1;break;
		case 6:P2_4=0;P2_3=1;P2_2=0;break;
		case 7:P2_4=0;P2_3=0;P2_2=1;break;
		case 8:P2_4=0;P2_3=0;P2_2=0;break;
	}
	P0=NixieTable[Number];	//æ®µç è¾“å‡º
}

/**
  * @brief  æ•°ç ç®¡é©±åŠ¨å‡½æ•°ï¼Œåœ¨ä¸­æ–­ä¸­è°ƒç”¨
  * @param  æ— 
  * @retval æ— 
  */
void Nixie_Loop(void)
{
	static unsigned char i=1;
	Nixie_Scan(i,Nixie_Buf[i]);
	i++;
	if(i>=9){i=1;}
}
```

```C
//Key.c
#include <REGX52.H>
#include "Delay.h"

unsigned char Key_KeyNumber;

/**
  * @brief  è·å–æŒ‰é”®é”®ç 
  * @param  æ— 
  * @retval æŒ‰ä¸‹æŒ‰é”®çš„é”®ç ï¼ŒèŒƒå›´ï¼š0,1~4,0è¡¨ç¤ºæ— æŒ‰é”®æŒ‰ä¸‹
  */
unsigned char Key(void)
{
	unsigned char Temp=0;
	Temp=Key_KeyNumber;
	Key_KeyNumber=0;
	return Temp;
}

/**
  * @brief  è·å–å½“å‰æŒ‰é”®çš„çŠ¶æ€ï¼Œæ— æ¶ˆæŠ–åŠæ¾æ‰‹æ£€æµ‹
  * @param  æ— 
  * @retval æŒ‰ä¸‹æŒ‰é”®çš„é”®ç ï¼ŒèŒƒå›´ï¼š0,1~4,0è¡¨ç¤ºæ— æŒ‰é”®æŒ‰ä¸‹
  */
unsigned char Key_GetState()
{
	unsigned char KeyNumber=0;
	
	if(P3_1==0){KeyNumber=1;}
	if(P3_0==0){KeyNumber=2;}
	if(P3_2==0){KeyNumber=3;}
	if(P3_3==0){KeyNumber=4;}
	
	return KeyNumber;
}

/**
  * @brief  æŒ‰é”®é©±åŠ¨å‡½æ•°ï¼Œåœ¨ä¸­æ–­ä¸­è°ƒç”¨
  * @param  æ— 
  * @retval æ— 
  */
void Key_Loop(void)
{
	static unsigned char NowState,LastState;
	LastState=NowState;				//æŒ‰é”®çŠ¶æ€æ›´æ–°
	NowState=Key_GetState();		//è·å–å½“å‰æŒ‰é”®çŠ¶æ€
	//å¦‚æœä¸Šä¸ªæ—¶é—´ç‚¹æŒ‰é”®æŒ‰ä¸‹ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹æœªæŒ‰ä¸‹ï¼Œåˆ™æ˜¯æ¾æ‰‹ç¬é—´ï¼Œä»¥æ­¤é¿å…æ¶ˆæŠ–å’Œæ¾æ‰‹æ£€æµ‹
	if(LastState==1 && NowState==0)
	{
		Key_KeyNumber=1;
	}
	if(LastState==2 && NowState==0)
	{
		Key_KeyNumber=2;
	}
	if(LastState==3 && NowState==0)
	{
		Key_KeyNumber=3;
	}
	if(LastState==4 && NowState==0)
	{
		Key_KeyNumber=4;
	}
}
```

```C
//main.c
#include <REGX52.H>
#include "Timer0.h"
#include "Key.h"
#include "Nixie.h"
#include "Delay.h"
#include "AT24C02.h"

unsigned char KeyNum;
unsigned char Min,Sec,MiniSec;
unsigned char RunFlag;

void main()
{
	Timer0_Init();
	while(1)
	{
		KeyNum=Key();
		if(KeyNum==1)			//K1æŒ‰é”®æŒ‰ä¸‹
		{
			RunFlag=!RunFlag;	//å¯åŠ¨æ ‡å¿—ä½ç¿»è½¬
		}
		if(KeyNum==2)			//K2æŒ‰é”®æŒ‰ä¸‹
		{
			Min=0;				//åˆ†ç§’æ¸…0
			Sec=0;
			MiniSec=0;
		}
		if(KeyNum==3)			//K3æŒ‰é”®æŒ‰ä¸‹
		{
			AT24C02_WriteByte(0,Min);	//å°†åˆ†ç§’å†™å…¥AT24C02
			Delay(5);
			AT24C02_WriteByte(1,Sec);
			Delay(5);
			AT24C02_WriteByte(2,MiniSec);
			Delay(5);
		}
		if(KeyNum==4)			//K4æŒ‰é”®æŒ‰ä¸‹
		{
			Min=AT24C02_ReadByte(0);	//è¯»å‡ºAT24C02æ•°æ®
			Sec=AT24C02_ReadByte(1);
			MiniSec=AT24C02_ReadByte(2);
		}
		Nixie_SetBuf(1,Min/10);	//è®¾ç½®æ˜¾ç¤ºç¼“å­˜ï¼Œæ˜¾ç¤ºæ•°æ®
		Nixie_SetBuf(2,Min%10);
		Nixie_SetBuf(3,11);
		Nixie_SetBuf(4,Sec/10);
		Nixie_SetBuf(5,Sec%10);
		Nixie_SetBuf(6,11);
		Nixie_SetBuf(7,MiniSec/10);
		Nixie_SetBuf(8,MiniSec%10);
	}
}

/**
  * @brief  ç§’è¡¨é©±åŠ¨å‡½æ•°ï¼Œåœ¨ä¸­æ–­ä¸­è°ƒç”¨
  * @param  æ— 
  * @retval æ— 
  */
void Sec_Loop(void)
{
	if(RunFlag)
	{
		MiniSec++;
		if(MiniSec>=100)
		{
			MiniSec=0;
			Sec++;
			if(Sec>=60)
			{
				Sec=0;
				Min++;
				if(Min>=60)
				{
					Min=0;
				}
			}
		}
	}
}

void Timer0_Routine() interrupt 1
{
	static unsigned int T0Count1,T0Count2,T0Count3;
	TL0 = 0x18;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0xFC;		//è®¾ç½®å®šæ—¶åˆå€¼
	T0Count1++;
	if(T0Count1>=20)
	{
		T0Count1=0;
		Key_Loop();	//20msè°ƒç”¨ä¸€æ¬¡æŒ‰é”®é©±åŠ¨å‡½æ•°
	}
	T0Count2++;
	if(T0Count2>=2)
	{
		T0Count2=0;
		Nixie_Loop();//2msè°ƒç”¨ä¸€æ¬¡æ•°ç ç®¡é©±åŠ¨å‡½æ•°
	}
	T0Count3++;
	if(T0Count3>=10)
	{
		T0Count3=0;
		Sec_Loop();	//10msè°ƒç”¨ä¸€æ¬¡æ•°ç§’è¡¨é©±åŠ¨å‡½æ•°
	}
}
```

---

## 13. DS18B20æ¸©åº¦ä¼ æ„Ÿå™¨

æ•°å­—æ¸©åº¦ä¼ æ„Ÿå™¨

### åŸç†

![DS18B02](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/DS18B02.png)

### 13.1 æ¸©åº¦è¯»å–

`å¤´æ–‡ä»¶`

```C
//OneWire.h
#ifndef __ONEWIRE_H__
#define __ONEWIRE_H__

unsigned char OneWire_Init(void);
void OneWire_SendBit(unsigned char Bit);
unsigned char OneWire_ReceiveBit(void);
void OneWire_SendByte(unsigned char Byte);
unsigned char OneWire_ReceiveByte(void);

#endif
```

```C
//DS18B02.h
#ifndef __DS18B20_H__
#define __DS18B20_H__

void DS18B20_ConvertT(void);
float DS18B20_ReadT(void);

#endif
```

`å‡½æ•°`

```C
//OneWire.c
#include <REGX52.H>

//å¼•è„šå®šä¹‰
sbit OneWire_DQ=P3^7;

/**
  * @brief  å•æ€»çº¿åˆå§‹åŒ–
  * @param  æ— 
  * @retval ä»æœºå“åº”ä½ï¼Œ0ä¸ºå“åº”ï¼Œ1ä¸ºæœªå“åº”
  */
unsigned char OneWire_Init(void)
{
	unsigned char i;
	unsigned char AckBit;
	OneWire_DQ=1;
	OneWire_DQ=0;
	i = 247;while (--i);		//Delay 500us
	OneWire_DQ=1;
	i = 32;while (--i);			//Delay 70us
	AckBit=OneWire_DQ;
	i = 247;while (--i);		//Delay 500us
	return AckBit;
}

/**
  * @brief  å•æ€»çº¿å‘é€ä¸€ä½
  * @param  Bit è¦å‘é€çš„ä½
  * @retval æ— 
  */
void OneWire_SendBit(unsigned char Bit)
{
	unsigned char i;
	OneWire_DQ=0;
	i = 4;while (--i);			//Delay 10us
	OneWire_DQ=Bit;
	i = 24;while (--i);			//Delay 50us
	OneWire_DQ=1;
}

/**
  * @brief  å•æ€»çº¿æ¥æ”¶ä¸€ä½
  * @param  æ— 
  * @retval è¯»å–çš„ä½
  */
unsigned char OneWire_ReceiveBit(void)
{
	unsigned char i;
	unsigned char Bit;
	OneWire_DQ=0;
	i = 2;while (--i);			//Delay 5us
	OneWire_DQ=1;
	i = 2;while (--i);			//Delay 5us
	Bit=OneWire_DQ;
	i = 24;while (--i);			//Delay 50us
	return Bit;
}

/**
  * @brief  å•æ€»çº¿å‘é€ä¸€ä¸ªå­—èŠ‚
  * @param  Byte è¦å‘é€çš„å­—èŠ‚
  * @retval æ— 
  */
void OneWire_SendByte(unsigned char Byte)
{
	unsigned char i;
	for(i=0;i<8;i++)
	{
		OneWire_SendBit(Byte&(0x01<<i));
	}
}

/**
  * @brief  å•æ€»çº¿æ¥æ”¶ä¸€ä¸ªå­—èŠ‚
  * @param  æ— 
  * @retval æ¥æ”¶çš„ä¸€ä¸ªå­—èŠ‚
  */
unsigned char OneWire_ReceiveByte(void)
{
	unsigned char i;
	unsigned char Byte=0x00;
	for(i=0;i<8;i++)
	{
		if(OneWire_ReceiveBit()){Byte|=(0x01<<i);}
	}
	return Byte;
}
```

```C
//DS18B02.c
#include <REGX52.H>
#include "OneWire.h"

//DS18B20æŒ‡ä»¤
#define DS18B20_SKIP_ROM          0xCC
#define DS18B20_CONVERT_T         0x44
#define DS18B20_READ_SCRATCHPAD 	0xBE

/**
  * @brief  DS18B20å¼€å§‹æ¸©åº¦å˜æ¢
  * @param  æ— 
  * @retval æ— 
  */
void DS18B20_ConvertT(void)
{
	OneWire_Init();
	OneWire_SendByte(DS18B20_SKIP_ROM);
	OneWire_SendByte(DS18B20_CONVERT_T);
}

/**
  * @brief  DS18B20è¯»å–æ¸©åº¦
  * @param  æ— 
  * @retval æ¸©åº¦æ•°å€¼
  */
float DS18B20_ReadT(void)
{
	unsigned char TLSB,TMSB;
	int Temp;
	float T;
	OneWire_Init();
	OneWire_SendByte(DS18B20_SKIP_ROM);
	OneWire_SendByte(DS18B20_READ_SCRATCHPAD);
	TLSB=OneWire_ReceiveByte();
	TMSB=OneWire_ReceiveByte();
	Temp=(TMSB<<8)|TLSB;
	T=Temp/16.0;
	return T;
}
```

```C
//main.c
#include <REGX52.H>
#include "LCD1602.h"
#include "DS18B20.h"
#include "Delay.h"

float T;

void main()
{
	DS18B20_ConvertT();		//ä¸Šç”µå…ˆè½¬æ¢ä¸€æ¬¡æ¸©åº¦ï¼Œé˜²æ­¢ç¬¬ä¸€æ¬¡è¯»æ•°æ®é”™è¯¯
	Delay(1000);			//ç­‰å¾…è½¬æ¢å®Œæˆ
	LCD_Init();
	LCD_ShowString(1,1,"Temperature:");
	while(1)
	{
		DS18B20_ConvertT();	//è½¬æ¢æ¸©åº¦
		T=DS18B20_ReadT();	//è¯»å–æ¸©åº¦
		if(T<0)				//å¦‚æœæ¸©åº¦å°äº0
		{
			LCD_ShowChar(2,1,'-');	//æ˜¾ç¤ºè´Ÿå·
			T=-T;			//å°†æ¸©åº¦å˜ä¸ºæ­£æ•°
		}
		else				//å¦‚æœæ¸©åº¦å¤§äºç­‰äº0
		{
			LCD_ShowChar(2,1,'+');	//æ˜¾ç¤ºæ­£å·
		}
		LCD_ShowNum(2,2,T,3);		//æ˜¾ç¤ºæ¸©åº¦æ•´æ•°éƒ¨åˆ†
		LCD_ShowChar(2,5,'.');		//æ˜¾ç¤ºå°æ•°ç‚¹
		LCD_ShowNum(2,6,(unsigned long)(T*10000)%10000,4);//æ˜¾ç¤ºæ¸©åº¦å°æ•°éƒ¨åˆ†
	}
}
```

### 13.2 æ¸©åº¦æŠ¥è­¦å™¨

`å¤´æ–‡ä»¶`

```c
//Key.h
#ifndef __KEY_H__
#define __KEY_H__

unsigned char Key(void);
void Key_Loop(void);

#endif
```

```C
//OneWire.h
#ifndef __DS18B20_H__
#define __DS18B20_H__

void DS18B20_ConvertT(void);
float DS18B20_ReadT(void);

#endif
```

`å‡½æ•°`

```C
//Key.c
#include <REGX52.H>
#include "Delay.h"

unsigned char Key_KeyNumber;

/**
  * @brief  è·å–æŒ‰é”®é”®ç 
  * @param  æ— 
  * @retval æŒ‰ä¸‹æŒ‰é”®çš„é”®ç ï¼ŒèŒƒå›´ï¼š0,1~4,0è¡¨ç¤ºæ— æŒ‰é”®æŒ‰ä¸‹
  */
unsigned char Key(void)
{
	unsigned char Temp=0;
	Temp=Key_KeyNumber;
	Key_KeyNumber=0;
	return Temp;
}

/**
  * @brief  è·å–å½“å‰æŒ‰é”®çš„çŠ¶æ€ï¼Œæ— æ¶ˆæŠ–åŠæ¾æ‰‹æ£€æµ‹
  * @param  æ— 
  * @retval æŒ‰ä¸‹æŒ‰é”®çš„é”®ç ï¼ŒèŒƒå›´ï¼š0,1~4,0è¡¨ç¤ºæ— æŒ‰é”®æŒ‰ä¸‹
  */
unsigned char Key_GetState()
{
	unsigned char KeyNumber=0;
	
	if(P3_1==0){KeyNumber=1;}
	if(P3_0==0){KeyNumber=2;}
	if(P3_2==0){KeyNumber=3;}
	if(P3_3==0){KeyNumber=4;}
	
	return KeyNumber;
}

/**
  * @brief  æŒ‰é”®é©±åŠ¨å‡½æ•°ï¼Œåœ¨ä¸­æ–­ä¸­è°ƒç”¨
  * @param  æ— 
  * @retval æ— 
  */
void Key_Loop(void)
{
	static unsigned char NowState,LastState;
	LastState=NowState;				//æŒ‰é”®çŠ¶æ€æ›´æ–°
	NowState=Key_GetState();		//è·å–å½“å‰æŒ‰é”®çŠ¶æ€
	//å¦‚æœä¸Šä¸ªæ—¶é—´ç‚¹æŒ‰é”®æŒ‰ä¸‹ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹æœªæŒ‰ä¸‹ï¼Œåˆ™æ˜¯æ¾æ‰‹ç¬é—´ï¼Œä»¥æ­¤é¿å…æ¶ˆæŠ–å’Œæ¾æ‰‹æ£€æµ‹
	if(LastState==1 && NowState==0)
	{
		Key_KeyNumber=1;
	}
	if(LastState==2 && NowState==0)
	{
		Key_KeyNumber=2;
	}
	if(LastState==3 && NowState==0)
	{
		Key_KeyNumber=3;
	}
	if(LastState==4 && NowState==0)
	{
		Key_KeyNumber=4;
	}
}
```

```C
//OneWire.c  å‡½æ•°æ”¹åŠ¨éƒ¨åˆ†(è·³å‡ºä¸­æ–­)å•æ€»çº¿ä¸èƒ½ä¸­æ–­
#include <REGX52.H>

//å¼•è„šå®šä¹‰
sbit OneWire_DQ=P3^7;

/**
  * @brief  å•æ€»çº¿åˆå§‹åŒ–
  * @param  æ— 
  * @retval ä»æœºå“åº”ä½ï¼Œ0ä¸ºå“åº”ï¼Œ1ä¸ºæœªå“åº”
  */
unsigned char OneWire_Init(void)
{
	unsigned char i;
	unsigned char AckBit;
	EA=0; 					//å…³é—­ä¸­æ–­
	OneWire_DQ=1;
	OneWire_DQ=0;
	i = 247;while (--i);		//Delay 500us
	OneWire_DQ=1;
	i = 32;while (--i);			//Delay 70us
	AckBit=OneWire_DQ;
	i = 247;while (--i);		//Delay 500us
	EA=1; 					//æ‰“å¼€ä¸­æ–­
	return AckBit;
}
.
.
.
```

```C
//main
#include <REGX52.H>
#include "LCD1602.h"
#include "DS18B20.h"
#include "Delay.h"
#include "AT24C02.h"
#include "Key.h"
#include "Timer0.h"
#include "Buzzer.h"

float T,TShow;
char TLow,THigh;
unsigned char KeyNum;

void main()
{
	DS18B20_ConvertT();		//ä¸Šç”µå…ˆè½¬æ¢ä¸€æ¬¡æ¸©åº¦ï¼Œé˜²æ­¢ç¬¬ä¸€æ¬¡è¯»æ•°æ®é”™è¯¯
	Delay(1000);			//ç­‰å¾…è½¬æ¢å®Œæˆ
	THigh=AT24C02_ReadByte(0);	//è¯»å–æ¸©åº¦é˜ˆå€¼æ•°æ®
	TLow=AT24C02_ReadByte(1);
	if(THigh>125 || TLow<-55 || THigh<=TLow)
	{
		THigh=20;			//å¦‚æœé˜ˆå€¼éæ³•ï¼Œåˆ™è®¾ä¸ºé»˜è®¤å€¼
		TLow=15;
	}
	LCD_Init();
	LCD_ShowString(1,1,"T:");
	LCD_ShowString(2,1,"TH:");
	LCD_ShowString(2,9,"TL:");
	LCD_ShowSignedNum(2,4,THigh,3);
	LCD_ShowSignedNum(2,12,TLow,3);
	Timer0_Init();
	
	while(1)
	{
		KeyNum=Key();
		
		/*æ¸©åº¦è¯»å–åŠæ˜¾ç¤º*/
		DS18B20_ConvertT();	//è½¬æ¢æ¸©åº¦
		T=DS18B20_ReadT();	//è¯»å–æ¸©åº¦
		if(T<0)				//å¦‚æœæ¸©åº¦å°äº0
		{
			LCD_ShowChar(1,3,'-');	//æ˜¾ç¤ºè´Ÿå·
			TShow=-T;		//å°†æ¸©åº¦å˜ä¸ºæ­£æ•°
		}
		else				//å¦‚æœæ¸©åº¦å¤§äºç­‰äº0
		{
			LCD_ShowChar(1,3,'+');	//æ˜¾ç¤ºæ­£å·
			TShow=T;
		}
		LCD_ShowNum(1,4,TShow,3);		//æ˜¾ç¤ºæ¸©åº¦æ•´æ•°éƒ¨åˆ†
		LCD_ShowChar(1,7,'.');		//æ˜¾ç¤ºå°æ•°ç‚¹
		LCD_ShowNum(1,8,(unsigned long)(TShow*100)%100,2);//æ˜¾ç¤ºæ¸©åº¦å°æ•°éƒ¨åˆ†
		
		/*é˜ˆå€¼åˆ¤æ–­åŠæ˜¾ç¤º*/
		if(KeyNum)
		{
			if(KeyNum==1)	//K1æŒ‰é”®ï¼ŒTHighè‡ªå¢
			{
				THigh++;
				if(THigh>125){THigh=125;}
			}
			if(KeyNum==2)	//K2æŒ‰é”®ï¼ŒTHighè‡ªå‡
			{
				THigh--;
				if(THigh<=TLow){THigh++;}
			}
			if(KeyNum==3)	//K3æŒ‰é”®ï¼ŒTLowè‡ªå¢
			{
				TLow++;
				if(TLow>=THigh){TLow--;}
			}
			if(KeyNum==4)	//K4æŒ‰é”®ï¼ŒTLowè‡ªå‡
			{
				TLow--;
				if(TLow<-55){TLow=-55;}
			}
			LCD_ShowSignedNum(2,4,THigh,3);	//æ˜¾ç¤ºé˜ˆå€¼æ•°æ®
			LCD_ShowSignedNum(2,12,TLow,3);
			AT24C02_WriteByte(0,THigh);		//å†™å…¥åˆ°At24C02ä¸­ä¿å­˜
			Delay(5);
			AT24C02_WriteByte(1,TLow);
			Delay(5);
		}
		if(T>THigh)			//è¶Šç•Œåˆ¤æ–­
		{
			LCD_ShowString(1,13,"OV:H");
			Buzzer_Time(100); //æŠ¥è­¦å™¨å‡½æ•°
		}
		else if(T<TLow)
		{
			LCD_ShowString(1,13,"OV:L");
			Buzzer_Time(100);
		}
		else
		{
			LCD_ShowString(1,13,"    ");
		}
	}
}

void Timer0_Routine() interrupt 1
{
	static unsigned int T0Count;
	TL0 = 0x18;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0xFC;		//è®¾ç½®å®šæ—¶åˆå€¼
	T0Count++;
	if(T0Count>=20)
	{
		T0Count=0;
		Key_Loop();	//æ¯20msè°ƒç”¨ä¸€æ¬¡æŒ‰é”®é©±åŠ¨å‡½æ•°
	}
}
```

---

## 14. LCD1602

LCDä¸æ•°ç ç®¡å¼•è„šå†²çª 

 ### åŸç†ï¼ˆå›¾ç‰‡ï¼‰

-  LCD1602æ¥å£           https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/LCD1602.png

- LCD1602æŒ‡ä»¤é›†       https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/LCD1602%E6%8C%87%E4%BB%A4%E9%9B%86.png
- LCD1602å­—æ¨¡		   https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/LCD1602%E5%AD%97%E6%A8%A1.png

###  ä»£ç 

`å¤´æ–‡ä»¶`

```C
//LCD_1602.h
#ifndef __LCD1602_H__
#define __LCD1602_H__

void LCD_Init(void);
void LCD_ShowChar(unsigned char Line,unsigned char Column,unsigned char Char);
void LCD_ShowString(unsigned char Line,unsigned char Column,unsigned char *String);
void LCD_ShowNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
void LCD_ShowSignedNum(unsigned char Line,unsigned char Column,int Number,unsigned char Length);
void LCD_ShowHexNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
void LCD_ShowBinNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
void LCD_WriteCommand(unsigned char Command);

#endif
```

`å‡½æ•°`

```C
//LCD_1602.c
#include <REGX52.H>

//å¼•è„šå®šä¹‰
sbit LCD_RS=P2^6;
sbit LCD_RW=P2^5;
sbit LCD_E=P2^7;
#define LCD_DataPort P0

/**
  * @brief  LCD1602å»¶æ—¶å‡½æ•°ï¼Œ12MHzè°ƒç”¨å¯å»¶æ—¶1ms
  * @param  æ— 
  * @retval æ— 
  */
void LCD_Delay()		//@12.000MHz 1ms
{
	unsigned char i, j;

	i = 2;
	j = 239;
	do
	{
		while (--j);
	} while (--i);
}

/**
  * @brief  LCD1602å†™å‘½ä»¤
  * @param  Command è¦å†™å…¥çš„å‘½ä»¤
  * @retval æ— 
  */
void LCD_WriteCommand(unsigned char Command)
{
	LCD_RS=0;
	LCD_RW=0;
	LCD_DataPort=Command;
	LCD_E=1;
	LCD_Delay();
	LCD_E=0;
	LCD_Delay();
}

/**
  * @brief  LCD1602å†™æ•°æ®
  * @param  Data è¦å†™å…¥çš„æ•°æ®
  * @retval æ— 
  */
void LCD_WriteData(unsigned char Data)
{
	LCD_RS=1;
	LCD_RW=0;
	LCD_DataPort=Data;
	LCD_E=1;
	LCD_Delay();
	LCD_E=0;
	LCD_Delay();
}

/**
  * @brief  LCD1602åˆå§‹åŒ–å‡½æ•°
  * @param  æ— 
  * @retval æ— 
  */
void LCD_Init(void)
{
	LCD_WriteCommand(0x38);
	LCD_WriteCommand(0x0C);
	LCD_WriteCommand(0x06);
	LCD_WriteCommand(0x01);
}

/**
  * @brief  LCD1602è®¾ç½®å…‰æ ‡ä½ç½®
  * @param  Line è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @retval æ— 
  */
void LCD_SetCursor(unsigned char Line,unsigned char Column)
{
	if(Line==1)
	{
		LCD_WriteCommand(0x80|(Column-1));
	}
	else
	{
		LCD_WriteCommand(0x80|(Column-1)+0x40);
	}
}

/**
  * @brief  åœ¨LCD1602æŒ‡å®šä½ç½®ä¸Šæ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦
  * @param  Line è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @param  Char è¦æ˜¾ç¤ºçš„å­—ç¬¦
  * @retval æ— 
  */
void LCD_ShowChar(unsigned char Line,unsigned char Column,unsigned char Char)
{
	LCD_SetCursor(Line,Column);
	LCD_WriteData(Char);
}

/**
  * @brief  åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹æ˜¾ç¤ºæ‰€ç»™å­—ç¬¦ä¸²
  * @param  Line èµ·å§‹è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column èµ·å§‹åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @param  String è¦æ˜¾ç¤ºçš„å­—ç¬¦ä¸²
  * @retval æ— 
  */
void LCD_ShowString(unsigned char Line,unsigned char Column,unsigned char *String)
{
	unsigned char i;
	LCD_SetCursor(Line,Column);
	for(i=0;String[i]!='\0';i++)
	{
		LCD_WriteData(String[i]);
	}
}

/**
  * @brief  è¿”å›å€¼=Xçš„Yæ¬¡æ–¹
  */
int LCD_Pow(int X,int Y)
{
	unsigned char i;
	int Result=1;
	for(i=0;i<Y;i++)
	{
		Result*=X;
	}
	return Result;
}

/**
  * @brief  åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹æ˜¾ç¤ºæ‰€ç»™æ•°å­—
  * @param  Line èµ·å§‹è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column èµ·å§‹åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @param  Number è¦æ˜¾ç¤ºçš„æ•°å­—ï¼ŒèŒƒå›´ï¼š0~65535
  * @param  Length è¦æ˜¾ç¤ºæ•°å­—çš„é•¿åº¦ï¼ŒèŒƒå›´ï¼š1~5
  * @retval æ— 
  */
void LCD_ShowNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
{
	unsigned char i;
	LCD_SetCursor(Line,Column);
	for(i=Length;i>0;i--)
	{
		LCD_WriteData('0'+Number/LCD_Pow(10,i-1)%10);
	}
}

/**
  * @brief  åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹ä»¥æœ‰ç¬¦å·åè¿›åˆ¶æ˜¾ç¤ºæ‰€ç»™æ•°å­—
  * @param  Line èµ·å§‹è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column èµ·å§‹åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @param  Number è¦æ˜¾ç¤ºçš„æ•°å­—ï¼ŒèŒƒå›´ï¼š-32768~32767
  * @param  Length è¦æ˜¾ç¤ºæ•°å­—çš„é•¿åº¦ï¼ŒèŒƒå›´ï¼š1~5
  * @retval æ— 
  */
void LCD_ShowSignedNum(unsigned char Line,unsigned char Column,int Number,unsigned char Length)
{
	unsigned char i;
	unsigned int Number1;
	LCD_SetCursor(Line,Column);
	if(Number>=0)
	{
		LCD_WriteData('+');
		Number1=Number;
	}
	else
	{
		LCD_WriteData('-');
		Number1=-Number;
	}
	for(i=Length;i>0;i--)
	{
		LCD_WriteData('0'+Number1/LCD_Pow(10,i-1)%10);
	}
}

/**
  * @brief  åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹ä»¥åå…­è¿›åˆ¶æ˜¾ç¤ºæ‰€ç»™æ•°å­—
  * @param  Line èµ·å§‹è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column èµ·å§‹åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @param  Number è¦æ˜¾ç¤ºçš„æ•°å­—ï¼ŒèŒƒå›´ï¼š0~0xFFFF
  * @param  Length è¦æ˜¾ç¤ºæ•°å­—çš„é•¿åº¦ï¼ŒèŒƒå›´ï¼š1~4
  * @retval æ— 
  */
void LCD_ShowHexNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
{
	unsigned char i;
	unsigned char SingleNumber;
	LCD_SetCursor(Line,Column);
	for(i=Length;i>0;i--)
	{
		SingleNumber=Number/LCD_Pow(16,i-1)%16;
		if(SingleNumber<10)
		{
			LCD_WriteData('0'+SingleNumber);
		}
		else
		{
			LCD_WriteData('A'+SingleNumber-10);
		}
	}
}

/**
  * @brief  åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹ä»¥äºŒè¿›åˆ¶æ˜¾ç¤ºæ‰€ç»™æ•°å­—
  * @param  Line èµ·å§‹è¡Œä½ç½®ï¼ŒèŒƒå›´ï¼š1~2
  * @param  Column èµ·å§‹åˆ—ä½ç½®ï¼ŒèŒƒå›´ï¼š1~16
  * @param  Number è¦æ˜¾ç¤ºçš„æ•°å­—ï¼ŒèŒƒå›´ï¼š0~1111 1111 1111 1111
  * @param  Length è¦æ˜¾ç¤ºæ•°å­—çš„é•¿åº¦ï¼ŒèŒƒå›´ï¼š1~16
  * @retval æ— 
  */
void LCD_ShowBinNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
{
	unsigned char i;
	LCD_SetCursor(Line,Column);
	for(i=Length;i>0;i--)
	{
		LCD_WriteData('0'+Number/LCD_Pow(2,i-1)%2);
	}
}
```

```C
//main.c
#include <REGX52.H>
#include "LCD1602.h"
#include "Delay.h"

void main()
{
	LCD_Init();						//LCDåˆå§‹åŒ–
	LCD_ShowChar(1,1,'A');			//åœ¨1è¡Œ1åˆ—æ˜¾ç¤ºå­—ç¬¦A
	LCD_ShowString(1,3,"Hello");	//åœ¨1è¡Œ3åˆ—æ˜¾ç¤ºå­—ç¬¦ä¸²Hello
	LCD_ShowNum(1,9,66,2);			//åœ¨1è¡Œ9åˆ—æ˜¾ç¤ºæ•°å­—66ï¼Œé•¿åº¦ä¸º2
	LCD_ShowSignedNum(1,12,-88,2);	//åœ¨1è¡Œ12åˆ—æ˜¾ç¤ºæœ‰ç¬¦å·æ•°å­—-88ï¼Œé•¿åº¦ä¸º2
	LCD_ShowHexNum(2,1,0xA5,2);		//åœ¨2è¡Œ1åˆ—æ˜¾ç¤ºåå…­è¿›åˆ¶æ•°å­—0xA5ï¼Œé•¿åº¦ä¸º2
	LCD_ShowBinNum(2,4,0xA5,8);		//åœ¨2è¡Œ4åˆ—æ˜¾ç¤ºäºŒè¿›åˆ¶æ•°å­—0xA5ï¼Œé•¿åº¦ä¸º8
	LCD_ShowChar(2,13,0xDF);		//åœ¨2è¡Œ13åˆ—æ˜¾ç¤ºç¼–ç ä¸º0xDFçš„å­—ç¬¦ 
	LCD_ShowChar(2,14,'C');			//åœ¨2è¡Œ14åˆ—æ˜¾ç¤ºå­—ç¬¦C
	LCD_ShowString(1,16,"Welcome to China!"); //å­—ç¬¦å¾€å·¦ç§»åŠ¨
	while(1)
	{
		LCD_WriteCommand(0x18);
		Delay(500);
	}
}
```

---

## 15. ç›´æµç”µæœºé©±åŠ¨(PWM)

### åŸç†

![äº”çº¿å››é¡¹æ­¥è¿›ç”µæœº](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/%E4%BA%94%E7%BA%BF%E5%9B%9B%E9%A1%B9%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA.png) 

### 15.1 LEDå‘¼å¸ç¯

```C
#include <REGX52.H>

sbit LED=P2^0;

void Delay(unsigned int t)
{
	while(t--);
}

void main()
{
	unsigned char Time,i;
	
	while(1)
	{
		for(Time=0;Time<100;Time++) //æš—->äº®
		{
			for(i=0;i<20;i++)
			{
				LED=0;
				Delay(Time);
				LED=1;
				Delay(100-Time);				
			}		
		}
		
		for(Time=100;Time>0;Time--) //äº®->æš—
		{
			for(i=0;i<20;i++)
			{
				LED=0;
				Delay(Time);
				LED=1;
				Delay(100-Time);				
			}		
		}
	}
}
```

### 15.2 ç›´æµç”µæœºè°ƒé€Ÿ

```C
//Timer0.c
#include <REGX52.H>

/**
  * @brief  å®šæ—¶å™¨0åˆå§‹åŒ–ï¼Œ100us@12.000MHz
  * @param  æ— 
  * @retval æ— 
  */
void Timer0_Init(void)
{
	TMOD &= 0xF0;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TMOD |= 0x01;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TL0 = 0x9C;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0xFF;		//è®¾ç½®å®šæ—¶åˆå€¼
	TF0 = 0;		//æ¸…é™¤TF0æ ‡å¿—
	TR0 = 1;		//å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
	ET0=1;
	EA=1;
	PT0=0;
}
```

```C
//main.c
#include <REGX52.H>
#include "Delay.h"
#include "Key.h"
#include "Nixie.h"
#include "Timer0.h"

sbit Motor=P1^0;  //ç»™1ç”µæœºè½¬

unsigned char Counter,Compare;
unsigned char KeyNum,Speed;

void main()
{
	Timer0_Init();
	Compare=90;
	while(1)
	{
		KeyNum=Key();
		if(KeyNum==1)
		{
			Speed++;
			Speed%=4;
			if(Speed==0) {Compare=0;} 
			if(Speed==1) {Compare=50;}
			if(Speed==2) {Compare=75;}
			if(Speed==3) {Compare=100;}
		}
		Nixie(1,Speed); //Speedè¶Šå¤§ï¼ŒCompareè¶Šå¤§,æ‰€å æ¯”ä¹Ÿå°±è¶Šå¤§
	}
}

void Timer0_Routine() interrupt 1
{
	TL0 = 0x9C;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0xFF;		//è®¾ç½®å®šæ—¶åˆå€¼
	Counter++;
	Counter%=100;
	if(Counter<Compare)
	{
		Motor=1;
	}
	else
	{
		Motor=0;
	}
}
```

---

## 16. AD/DA

### åŸç†

ADï¼šæ¨¡æ‹Ÿ--æ•°å­—è½¬æ¢ï¼Œæ¨¡æ‹Ÿä¿¡å·å˜ä¸ºè®¡ç®—æœºå¯æ“ä½œçš„æ•°å­—ä¿¡å·

DAï¼šæ•°å­—--æ¨¡æ‹Ÿè½¬æ¢

![ADC](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/ADC.png)

![DAC](https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/DAC.png)

### ADæ¨¡æ•°è½¬æ¢

`å¤´æ–‡ä»¶`

```C
//XPT2046.h
#ifndef __XPT2046_H_
#define __XPT2046_H_
//8ä½
#define XPT2046_XP_8    0x9C
#define XPT2046_YP_8    0xDC
#define XPT2046_VBAT_8  0xAC
#define XPT2046_AUX_8   0xEC
//12ä½
#define XPT2046_XP_12    0x94
#define XPT2046_YP_12    0xD4
#define XPT2046_VBAT_12  0xA4
#define XPT2046_AUX_12   0xE4

unsigned int XPT2046_ReadAD(unsigned char Command);

#endif
```

`å‡½æ•°`

```C
//XPT2046.c
#include <REGX52.H>
//å¼•è„šå®šä¹‰
sbit XPT2046_CS=P3^5;
sbit XPT2046_DCLK=P3^6;
sbit XPT2046_DIN=P3^4;
sbit XPT2046_DOUT=P3^7;

/**
  * @brief  ZPT2046è¯»å–ADå€¼
  * @param  Command å‘½ä»¤å­—ï¼ŒèŒƒå›´ï¼šå¤´æ–‡ä»¶å†…å®šä¹‰çš„å®ï¼Œç»“å°¾çš„æ•°å­—è¡¨ç¤ºè½¬æ¢çš„ä½æ•°
  * @retval ADè½¬æ¢åçš„æ•°å­—é‡ï¼ŒèŒƒå›´ï¼š8ä½ä¸º0~255ï¼Œ12ä½ä¸º0~4095
  */
unsigned int XPT2046_ReadAD(unsigned char Command)
{
	unsigned  char i;
	unsigned int ADValue=0;
	XPT2046_DCLK=0;
	XPT2046_CS=0;
	
	for(i=0;i<8;i++)
	{
		XPT2046_DIN=Command&(0x80>>i);
		XPT2046_DCLK=1;
		XPT2046_DCLK=0;
	}

	for(i=0;i<16;i++)
	{
		
	  XPT2046_DCLK=1;
		XPT2046_DCLK=0;
		if(XPT2046_DOUT) {ADValue|=(0x8000>>i);}
	}
	XPT2046_CS=1;
	if(Command&0x08)
	{
		return ADValue>>8; //8ä½æ˜¾ç¤º
	}
	else return ADValue>>4; //12ä½æ˜¾ç¤º
}
```

```C
//main.c
#include <REGX52.H>
#include "LCD1602.h"
#include "Delay.h"
#include "XPT2046.h"

unsigned int ADValue;

void main()
{
	LCD_Init();
	LCD_ShowString(1,1,"ADJ NTC RG");
	while(1)
	{
		ADValue= XPT2046_ReadAD(XPT2046_XP_8); //è¯»å–AIN0ï¼Œå¯è°ƒç”µé˜»
		LCD_ShowNum(2,1,ADValue,3);
		ADValue= XPT2046_ReadAD(XPT2046_YP_8); //è¯»å–AIN1ï¼Œçƒ­æ•ç”µé˜»
		LCD_ShowNum(2,5,ADValue,3);
		ADValue= XPT2046_ReadAD(XPT2046_VBAT_8);  //è¯»å–AIN2ï¼Œå…‰æ•ç”µé˜»
		LCD_ShowNum(2,9,ADValue,3);
		Delay(10);
		
	}
}
```

### DAæ•°æ¨¡è½¬æ¢

```C
//main.c ç›´æµç”µæœºå¾®æ”¹
#include <REGX52.H>
#include "Delay.h"
#include "Timer0.h"

sbit DA=P2^1;

unsigned char Counter,Compare;	//è®¡æ•°å€¼å’Œæ¯”è¾ƒå€¼ï¼Œç”¨äºè¾“å‡ºPWM
unsigned char i;

void main()
{
	Timer0_Init();
	while(1)
	{
		for(i=0;i<100;i++)
		{
			Compare=i;			//è®¾ç½®æ¯”è¾ƒå€¼ï¼Œæ”¹å˜PWMå ç©ºæ¯”
			Delay(10);
		}
		for(i=100;i>0;i--)
		{
			Compare=i;			//è®¾ç½®æ¯”è¾ƒå€¼ï¼Œæ”¹å˜PWMå ç©ºæ¯”
			Delay(10);
		}
	}
}

void Timer0_Routine() interrupt 1
{
	TL0 = 0x9C;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0xFF;		//è®¾ç½®å®šæ—¶åˆå€¼
	Counter++;
	Counter%=100;	//è®¡æ•°å€¼å˜åŒ–èŒƒå›´é™åˆ¶åœ¨0~99
	if(Counter<Compare)	//è®¡æ•°å€¼å°äºæ¯”è¾ƒå€¼
	{
		DA=1;		//è¾“å‡º1
	}
	else				//è®¡æ•°å€¼å¤§äºæ¯”è¾ƒå€¼
	{
		DA=0;		//è¾“å‡º0
	}
}
```

---

## 17. çº¢å¤–é¥æ§

### åŸç†

<img src="https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/%E7%BA%A2%E5%A4%96%E6%8E%A5%E6%94%B6%E6%A8%A1%E5%9D%97.png" alt="çº¢å¤–æ¥æ”¶æ¨¡å—" style="zoom:50%;" />

`é¥æ§å™¨é”®ç `

<img src="https://yy.liveout.cn/article/Learn/cmicrocpu/22_12/%E9%81%A5%E6%8E%A7%E5%99%A8%E9%94%AE%E7%A0%81.png" alt="é¥æ§å™¨" style="zoom:80%;" />

### 17.1 çº¢å¤–é¥æ§

`å¤´æ–‡ä»¶`

```C
//Int0.h
#ifndef __INT0_H__
#define __INT0_H__

void Int0_Init(void);

#endif
```

```C
//Timer0.h
#ifndef __TIMER0_H__
#define __TIMER0_H__

void Timer0_Init(void);
void Timer0_SetCounter(unsigned int Value);
unsigned int Timer0_GetCounter(void);
void Timer0_Run(unsigned char Flag);

#endif
```

```C
//IR.h
#ifndef __IR_H__
#define __IR_H__

#define IR_POWER		0x45
#define IR_MODE			0x46
#define IR_MUTE			0x47
#define IR_START_STOP	0x44
#define IR_PREVIOUS		0x40
#define IR_NEXT			0x43
#define IR_EQ			0x07
#define IR_VOL_MINUS	0x15
#define IR_VOL_ADD		0x09
#define IR_0			0x16
#define IR_RPT			0x19
#define IR_USD			0x0D
#define IR_1			0x0C
#define IR_2			0x18
#define IR_3			0x5E
#define IR_4			0x08
#define IR_5			0x1C
#define IR_6			0x5A
#define IR_7			0x42
#define IR_8			0x52
#define IR_9			0x4A

void IR_Init(void);
unsigned char IR_GetDataFlag(void);
unsigned char IR_GetRepeatFlag(void);
unsigned char IR_GetAddress(void);
unsigned char IR_GetCommand(void);

#endif
```

`å‡½æ•°`

```C
//Int0.c
#include <REGX52.H>

/**
  * @brief  å¤–éƒ¨ä¸­æ–­0åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void Int0_Init(void)
{
	IT0=1;
	IE0=0;
	EX0=1;
	EA=1;
	PX0=1;
}

/*å¤–éƒ¨ä¸­æ–­0ä¸­æ–­å‡½æ•°æ¨¡æ¿
void Int0_Routine(void) interrupt 0
{
	
}
*/
```

```C
//Timer0.c
#include <REGX52.H>

/**
  * @brief  å®šæ—¶å™¨0åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void Timer0_Init(void)
{
	TMOD &= 0xF0;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TMOD |= 0x01;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TL0 = 0;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0;		//è®¾ç½®å®šæ—¶åˆå€¼
	TF0 = 0;		//æ¸…é™¤TF0æ ‡å¿—
	TR0 = 0;		//å®šæ—¶å™¨0ä¸è®¡æ—¶
}

/**
  * @brief  å®šæ—¶å™¨0è®¾ç½®è®¡æ•°å™¨å€¼
  * @param  Valueï¼Œè¦è®¾ç½®çš„è®¡æ•°å™¨å€¼ï¼ŒèŒƒå›´ï¼š0~65535
  * @retval æ— 
  */
void Timer0_SetCounter(unsigned int Value)
{
	TH0=Value/256;
	TL0=Value%256;
}

/**
  * @brief  å®šæ—¶å™¨0è·å–è®¡æ•°å™¨å€¼
  * @param  æ— 
  * @retval è®¡æ•°å™¨å€¼ï¼ŒèŒƒå›´ï¼š0~65535
  */
unsigned int Timer0_GetCounter(void)
{
	return (TH0<<8)|TL0;
}

/**
  * @brief  å®šæ—¶å™¨0å¯åŠ¨åœæ­¢æ§åˆ¶
  * @param  Flag å¯åŠ¨åœæ­¢æ ‡å¿—ï¼Œ1ä¸ºå¯åŠ¨ï¼Œ0ä¸ºåœæ­¢
  * @retval æ— 
  */
void Timer0_Run(unsigned char Flag)
{
	TR0=Flag;
}
```

```C
//IR.c
#include <REGX52.H>
#include "Timer0.h"
#include "Int0.h"

unsigned int IR_Time;
unsigned char IR_State;

unsigned char IR_Data[4];
unsigned char IR_pData;

unsigned char IR_DataFlag;
unsigned char IR_RepeatFlag;
unsigned char IR_Address;
unsigned char IR_Command;

/**
  * @brief  çº¢å¤–é¥æ§åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void IR_Init(void)
{
	Timer0_Init();
	Int0_Init();
}

/**
  * @brief  çº¢å¤–é¥æ§è·å–æ”¶åˆ°æ•°æ®å¸§æ ‡å¿—ä½
  * @param  æ— 
  * @retval æ˜¯å¦æ”¶åˆ°æ•°æ®å¸§ï¼Œ1ä¸ºæ”¶åˆ°ï¼Œ0ä¸ºæœªæ”¶åˆ°
  */
unsigned char IR_GetDataFlag(void)
{
	if(IR_DataFlag)
	{
		IR_DataFlag=0;
		return 1;
	}
	return 0;
}

/**
  * @brief  çº¢å¤–é¥æ§è·å–æ”¶åˆ°è¿å‘å¸§æ ‡å¿—ä½
  * @param  æ— 
  * @retval æ˜¯å¦æ”¶åˆ°è¿å‘å¸§ï¼Œ1ä¸ºæ”¶åˆ°ï¼Œ0ä¸ºæœªæ”¶åˆ°
  */
unsigned char IR_GetRepeatFlag(void)
{
	if(IR_RepeatFlag)
	{
		IR_RepeatFlag=0;
		return 1;
	}
	return 0;
}

/**
  * @brief  çº¢å¤–é¥æ§è·å–æ”¶åˆ°çš„åœ°å€æ•°æ®
  * @param  æ— 
  * @retval æ”¶åˆ°çš„åœ°å€æ•°æ®
  */
unsigned char IR_GetAddress(void)
{
	return IR_Address;
}

/**
  * @brief  çº¢å¤–é¥æ§è·å–æ”¶åˆ°çš„å‘½ä»¤æ•°æ®
  * @param  æ— 
  * @retval æ”¶åˆ°çš„å‘½ä»¤æ•°æ®
  */
unsigned char IR_GetCommand(void)
{
	return IR_Command;
}

//å¤–éƒ¨ä¸­æ–­0ä¸­æ–­å‡½æ•°ï¼Œä¸‹é™æ²¿è§¦å‘æ‰§è¡Œ
void Int0_Routine(void) interrupt 0
{
	if(IR_State==0)				//çŠ¶æ€0ï¼Œç©ºé—²çŠ¶æ€
	{
		Timer0_SetCounter(0);	//å®šæ—¶è®¡æ•°å™¨æ¸…0
		Timer0_Run(1);			//å®šæ—¶å™¨å¯åŠ¨
		IR_State=1;				//ç½®çŠ¶æ€ä¸º1
	}
	else if(IR_State==1)		//çŠ¶æ€1ï¼Œç­‰å¾…Startä¿¡å·æˆ–Repeatä¿¡å·
	{
		IR_Time=Timer0_GetCounter();	//è·å–ä¸Šä¸€æ¬¡ä¸­æ–­åˆ°æ­¤æ¬¡ä¸­æ–­çš„æ—¶é—´
		Timer0_SetCounter(0);	//å®šæ—¶è®¡æ•°å™¨æ¸…0
		//å¦‚æœè®¡æ—¶ä¸º13.5msï¼Œåˆ™æ¥æ”¶åˆ°äº†Startä¿¡å·ï¼ˆåˆ¤å®šå€¼åœ¨12MHzæ™¶æŒ¯ä¸‹ä¸º13500ï¼Œåœ¨11.0592MHzæ™¶æŒ¯ä¸‹ä¸º12442ï¼‰
		if(IR_Time>12442-500 && IR_Time<12442+500)
		{
			IR_State=2;			//ç½®çŠ¶æ€ä¸º2
		}
		//å¦‚æœè®¡æ—¶ä¸º11.25msï¼Œåˆ™æ¥æ”¶åˆ°äº†Repeatä¿¡å·ï¼ˆåˆ¤å®šå€¼åœ¨12MHzæ™¶æŒ¯ä¸‹ä¸º11250ï¼Œåœ¨11.0592MHzæ™¶æŒ¯ä¸‹ä¸º10368ï¼‰
		else if(IR_Time>10368-500 && IR_Time<10368+500)
		{
			IR_RepeatFlag=1;	//ç½®æ”¶åˆ°è¿å‘å¸§æ ‡å¿—ä½ä¸º1
			Timer0_Run(0);		//å®šæ—¶å™¨åœæ­¢
			IR_State=0;			//ç½®çŠ¶æ€ä¸º0
		}
		else					//æ¥æ”¶å‡ºé”™
		{
			IR_State=1;			//ç½®çŠ¶æ€ä¸º1
		}
	}
	else if(IR_State==2)		//çŠ¶æ€2ï¼Œæ¥æ”¶æ•°æ®
	{
		IR_Time=Timer0_GetCounter();	//è·å–ä¸Šä¸€æ¬¡ä¸­æ–­åˆ°æ­¤æ¬¡ä¸­æ–­çš„æ—¶é—´
		Timer0_SetCounter(0);	//å®šæ—¶è®¡æ•°å™¨æ¸…0
		//å¦‚æœè®¡æ—¶ä¸º1120usï¼Œåˆ™æ¥æ”¶åˆ°äº†æ•°æ®0ï¼ˆåˆ¤å®šå€¼åœ¨12MHzæ™¶æŒ¯ä¸‹ä¸º1120ï¼Œåœ¨11.0592MHzæ™¶æŒ¯ä¸‹ä¸º1032ï¼‰
		if(IR_Time>1032-500 && IR_Time<1032+500)
		{
			IR_Data[IR_pData/8]&=~(0x01<<(IR_pData%8));	//æ•°æ®å¯¹åº”ä½æ¸…0
			IR_pData++;			//æ•°æ®ä½ç½®æŒ‡é’ˆè‡ªå¢
		}
		//å¦‚æœè®¡æ—¶ä¸º2250usï¼Œåˆ™æ¥æ”¶åˆ°äº†æ•°æ®1ï¼ˆåˆ¤å®šå€¼åœ¨12MHzæ™¶æŒ¯ä¸‹ä¸º2250ï¼Œåœ¨11.0592MHzæ™¶æŒ¯ä¸‹ä¸º2074ï¼‰
		else if(IR_Time>2074-500 && IR_Time<2074+500)
		{
			IR_Data[IR_pData/8]|=(0x01<<(IR_pData%8));	//æ•°æ®å¯¹åº”ä½ç½®1
			IR_pData++;			//æ•°æ®ä½ç½®æŒ‡é’ˆè‡ªå¢
		}
		else					//æ¥æ”¶å‡ºé”™
		{
			IR_pData=0;			//æ•°æ®ä½ç½®æŒ‡é’ˆæ¸…0
			IR_State=1;			//ç½®çŠ¶æ€ä¸º1
		}
		if(IR_pData>=32)		//å¦‚æœæ¥æ”¶åˆ°äº†32ä½æ•°æ®
		{
			IR_pData=0;			//æ•°æ®ä½ç½®æŒ‡é’ˆæ¸…0
			if((IR_Data[0]==~IR_Data[1]) && (IR_Data[2]==~IR_Data[3]))	//æ•°æ®éªŒè¯
			{
				IR_Address=IR_Data[0];	//è½¬å­˜æ•°æ®
				IR_Command=IR_Data[2];
				IR_DataFlag=1;	//ç½®æ”¶åˆ°è¿å‘å¸§æ ‡å¿—ä½ä¸º1
			}
			Timer0_Run(0);		//å®šæ—¶å™¨åœæ­¢
			IR_State=0;			//ç½®çŠ¶æ€ä¸º0
		}
	}
}
```

```C
//main.c
#include <REGX52.H>
#include "Delay.h"
#include "LCD1602.h"
#include "IR.h"

unsigned char Num;
unsigned char Address;
unsigned char Command;

void main()
{
	LCD_Init();
	LCD_ShowString(1,1,"ADDR  CMD  NUM");
	LCD_ShowString(2,1,"00    00   000");
	
	IR_Init();
	
	while(1)
	{
		if(IR_GetDataFlag() || IR_GetRepeatFlag())	//å¦‚æœæ”¶åˆ°æ•°æ®å¸§æˆ–è€…æ”¶åˆ°è¿å‘å¸§
		{
			Address=IR_GetAddress();		//è·å–é¥æ§å™¨åœ°å€ç 
			Command=IR_GetCommand();		//è·å–é¥æ§å™¨å‘½ä»¤ç 
			
			LCD_ShowHexNum(2,1,Address,2);	//æ˜¾ç¤ºé¥æ§å™¨åœ°å€ç 
			LCD_ShowHexNum(2,7,Command,2);	//æ˜¾ç¤ºé¥æ§å™¨å‘½ä»¤ç 
			
			if(Command==IR_VOL_MINUS)		//å¦‚æœé¥æ§å™¨VOL-æŒ‰é”®æŒ‰ä¸‹
			{
				Num--;						//Numè‡ªå‡
			}
			if(Command==IR_VOL_ADD)			//å¦‚æœé¥æ§å™¨VOL+æŒ‰é”®æŒ‰ä¸‹
			{
				Num++;						//Numè‡ªå¢
			}
			
			LCD_ShowNum(2,12,Num,3);		//æ˜¾ç¤ºNum
		}
	}
}
```

### 17.2  çº¢å¤–é¥æ§ç”µæœºè°ƒé€Ÿ

`å¤´æ–‡ä»¶`

```C
//Timer1.h
#ifndef __TIMER1_H__
#define __TIMER1___

void Timer1_Init(void);

#endif
```

```C
//Motor.h
#ifndef __MOTOR_H__
#define __MOTOR_H__

void Motor_Init(void);
void Motor_SetSpeed(unsigned char Speed);

#endif
```

```C
//Int0.h
#ifndef __INT0_H__
#define __INT0_H__

void Int0_Init(void);

#endif
```

```C
//Timer0.h
#ifndef __TIMER0_H__
#define __TIMER0_H__

void Timer0_Init(void);
void Timer0_SetCounter(unsigned int Value);
unsigned int Timer0_GetCounter(void);
void Timer0_Run(unsigned char Flag);

#endif
```

`å‡½æ•°`

```C
//Timer1.c
#include <REGX52.H>

/**
  * @brief  å®šæ—¶å™¨1åˆå§‹åŒ–ï¼Œ100us@12.000MHz
  * @param  æ— 
  * @retval æ— 
  */
void Timer1_Init(void)
{
	TMOD &= 0x0F;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TMOD |= 0x10;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TL1 = 0x9C;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH1 = 0xFF;		//è®¾ç½®å®šæ—¶åˆå€¼
	TF1 = 0;		//æ¸…é™¤TF1æ ‡å¿—
	TR1 = 1;		//å®šæ—¶å™¨1å¼€å§‹è®¡æ—¶
	ET1=1;
	EA=1;
	PT1=0;
}

/*å®šæ—¶å™¨ä¸­æ–­å‡½æ•°æ¨¡æ¿
void Timer1_Routine() interrupt 3
{
	static unsigned int T1Count;
	TL1 = 0x9C;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH1 = 0xFF;		//è®¾ç½®å®šæ—¶åˆå€¼
	T1Count++;
	if(T1Count>=1000)
	{
		T1Count=0;
		
	}
}
*/
```

```C
//Motor.c
#include <REGX52.H>
#include "Timer1.h"

//å¼•è„šå®šä¹‰
sbit Motor=P1^0;

unsigned char Counter,Compare;

/**
  * @brief  ç”µæœºåˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void Motor_Init(void)
{
	Timer1_Init();
}

/**
  * @brief  ç”µæœºè®¾ç½®é€Ÿåº¦
  * @param  Speed è¦è®¾ç½®çš„é€Ÿåº¦ï¼ŒèŒƒå›´0~100
  * @retval æ— 
  */
void Motor_SetSpeed(unsigned char Speed)
{
	Compare=Speed;
}

//å®šæ—¶å™¨1ä¸­æ–­å‡½æ•°
void Timer1_Routine() interrupt 3
{
	TL1 = 0x9C;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH1 = 0xFF;		//è®¾ç½®å®šæ—¶åˆå€¼
	Counter++;
	Counter%=100;	//è®¡æ•°å€¼å˜åŒ–èŒƒå›´é™åˆ¶åœ¨0~99
	if(Counter<Compare)	//è®¡æ•°å€¼å°äºæ¯”è¾ƒå€¼
	{
		Motor=1;		//è¾“å‡º1
	}
	else				//è®¡æ•°å€¼å¤§äºæ¯”è¾ƒå€¼
	{
		Motor=0;		//è¾“å‡º0
	}
}
```

```C
//Int0.c
#include <REGX52.H>

/**
  * @brief  å¤–éƒ¨ä¸­æ–­0åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void Int0_Init(void)
{
	IT0=1;
	IE0=0;
	EX0=1;
	EA=1;
	PX0=1;
}

/*å¤–éƒ¨ä¸­æ–­0ä¸­æ–­å‡½æ•°æ¨¡æ¿
void Int0_Routine(void) interrupt 0
{
	
}
*/
```

```C
#include <REGX52.H>

/**
  * @brief  å®šæ—¶å™¨0åˆå§‹åŒ–
  * @param  æ— 
  * @retval æ— 
  */
void Timer0_Init(void)
{
	TMOD &= 0xF0;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TMOD |= 0x01;		//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TL0 = 0;		//è®¾ç½®å®šæ—¶åˆå€¼
	TH0 = 0;		//è®¾ç½®å®šæ—¶åˆå€¼
	TF0 = 0;		//æ¸…é™¤TF0æ ‡å¿—
	TR0 = 0;		//å®šæ—¶å™¨0ä¸è®¡æ—¶
}

/**
  * @brief  å®šæ—¶å™¨0è®¾ç½®è®¡æ•°å™¨å€¼
  * @param  Valueï¼Œè¦è®¾ç½®çš„è®¡æ•°å™¨å€¼ï¼ŒèŒƒå›´ï¼š0~65535
  * @retval æ— 
  */
void Timer0_SetCounter(unsigned int Value)
{
	TH0=Value/256;
	TL0=Value%256;
}

/**
  * @brief  å®šæ—¶å™¨0è·å–è®¡æ•°å™¨å€¼
  * @param  æ— 
  * @retval è®¡æ•°å™¨å€¼ï¼ŒèŒƒå›´ï¼š0~65535
  */
unsigned int Timer0_GetCounter(void)
{
	return (TH0<<8)|TL0;


/**
  * @brief  å®šæ—¶å™¨0å¯åŠ¨åœæ­¢æ§åˆ¶
  * @param  Flag å¯åŠ¨åœæ­¢æ ‡å¿—ï¼Œ1ä¸ºå¯åŠ¨ï¼Œ0ä¸ºåœæ­¢
  * @retval æ— 
  */
void Timer0_Run(unsigned char Flag)
{
	TR0=Flag;
}
```

```C
//main.c
#include <REGX52.H>
#include "Delay.h"
#include "Key.h"
#include "Nixie.h"
#include "Motor.h"
#include "IR.h"

unsigned char Command,Speed;

void main()
{
	Motor_Init();
	IR_Init();
	while(1)
	{
		if(IR_GetDataFlag())	//å¦‚æœæ”¶åˆ°æ•°æ®å¸§
		{
			Command=IR_GetCommand();		//è·å–é¥æ§å™¨å‘½ä»¤ç 
			
			if(Command==IR_0){Speed=0;}		//æ ¹æ®é¥æ§å™¨å‘½ä»¤ç è®¾ç½®é€Ÿåº¦
			if(Command==IR_1){Speed=1;}
			if(Command==IR_2){Speed=2;}
			if(Command==IR_3){Speed=3;}
			
			if(Speed==0){Motor_SetSpeed(0);}	//é€Ÿåº¦è¾“å‡º
			if(Speed==1){Motor_SetSpeed(50);}
			if(Speed==2){Motor_SetSpeed(75);}
			if(Speed==3){Motor_SetSpeed(100);}
		}
		Nixie(1,Speed);						//æ•°ç ç®¡æ˜¾ç¤ºé€Ÿåº¦
	}
}

```

èŠœæ¹–ï¼Œæœ¬æ–‡ç« äº  `2022-12-14`  å®Œç»“æ•£èŠ±~~~     åç»­ä¼šæŒç»­ä¼˜åŒ–æœ¬æ–‡

ä¸‹é¢å¼€å¯STM32çš„æ—…é€”ğŸ˜­